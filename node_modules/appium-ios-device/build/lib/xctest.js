"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Xctest = void 0;
require("source-map-support/register");
var _services = require("./services");
var _instrument = require("./instrument");
var _headers = require("./instrument/headers");
var _nskeyed = require("./instrument/transformer/nskeyed");
var _testmanagerd = require("./testmanagerd");
var _support = require("@appium/support");
var _utilities = require("./utilities");
var _logger = _interopRequireDefault(require("./logger"));
var _bluebird = _interopRequireDefault(require("bluebird"));
const {
  DAEMON_CONNECTION_INTERFACE
} = _testmanagerd.TESTMANAGERD_CHANNEL;
const XCTEST_CONFIGURATION_EXTENSION = '.xctestconfiguration';
const TMP_FOLDER_PREFIX = '/tmp';
const XCTEST_EXECUTABLE_SUFFIX = '-Runner';
const MAJOR_IOS_VERSION_9 = 9;
const MAJOR_IOS_VERSION_11 = 11;
const MAJOR_IOS_VERSION_12 = 12;
const XCODE_BUILD_PATH = '/Applications/Xcode.app/Contents/Developer/usr/bin/xcodebuild';
const XCODE_VERSION = 29;
const MAGIC_CHANNEL = 0xFFFFFFFF;
class Xctest {
  constructor(udid, xctestBundleId, targetBundleId = null, opts = {}) {
    this.udid = udid;
    this.running = false;
    this._executing = false;
    this.xctestBundleId = xctestBundleId;
    this.targetBundleId = targetBundleId;
    this._conf = (opts === null || opts === void 0 ? void 0 : opts.conf) || {};
    this._env = (opts === null || opts === void 0 ? void 0 : opts.env) || {};
  }
  async _launchAppRunner(majorVersion, sessionIdentifier) {
    const {
      PROCESS_CONTROL
    } = _instrument.INSTRUMENT_CHANNEL;
    const installation = await (0, _services.startInstallationProxyService)(this.udid);
    let lookupResult;
    try {
      lookupResult = await installation.lookupApplications({
        bundleIds: [this.xctestBundleId]
      });
    } finally {
      installation.close();
    }
    const appInfo = lookupResult[this.xctestBundleId];
    if (!appInfo) {
      throw new Error(`${this.xctestBundleId} not found on device ${this.udid}`);
    }
    const signerIdentifier = appInfo.SignerIdentity;
    _logger.default.info(`SignerIdentifier: ${signerIdentifier}`);
    const appContainer = appInfo.Container;
    const execName = appInfo.CFBundleExecutable;
    if (!execName.endsWith(XCTEST_EXECUTABLE_SUFFIX)) {
      throw new Error(`Invalid CFBundleExecutable ${execName} from ${this.xctestBundleId}, is this bundle a valid xctest app?`);
    }
    const targetName = execName.substr(0, execName.indexOf(XCTEST_EXECUTABLE_SUFFIX));
    const xctestPath = `${TMP_FOLDER_PREFIX}/${targetName}-${sessionIdentifier.toUpperCase()}${XCTEST_CONFIGURATION_EXTENSION}`;
    const xctestConfiguration = new _nskeyed.XCTestConfiguration({
      ...this._conf,
      testBundleURL: `file://${appInfo.Path}/PlugIns/${targetName}.xctest`,
      sessionIdentifier,
      targetApplicationBundleID: this.targetBundleId
    });
    await this._writeConfigurationToDevice(xctestConfiguration, xctestPath);
    this._instrumentService = await (0, _services.startInstrumentService)(this.udid);
    this._instrumentService.registerLifecycleCallback('close', this.stop.bind(this));
    await this._instrumentService.callChannel(PROCESS_CONTROL, 'processIdentifierForBundleIdentifier:', this.xctestBundleId);
    const appPath = appInfo.Path;
    const xctestConfigurationPath = appContainer + xctestPath;
    const appEnv = {
      CA_ASSERT_MAIN_THREAD_TRANSACTIONS: '0',
      CA_DEBUG_TRANSACTIONS: '0',
      DYLD_FRAMEWORK_PATH: `${appPath}/Frameworks:`,
      DYLD_LIBRARY_PATH: `${appPath}/Frameworks`,
      NSUnbufferedIO: 'YES',
      SQLITE_ENABLE_THREAD_ASSERTIONS: '1',
      WDA_PRODUCT_BUNDLE_IDENTIFIER: '',
      XCTestConfigurationFilePath: xctestConfigurationPath,
      XCODE_DBG_XPC_EXCLUSIONS: 'com.apple.dt.xctestSymbolicator',
      MJPEG_SERVER_PORT: '',
      USE_PORT: '',
      LLVM_PROFILE_FILE: `${appContainer}/tmp/%p.profraw`,
      ...this._env
    };
    if (majorVersion >= MAJOR_IOS_VERSION_11) {
      appEnv.DYLD_INSERT_LIBRARIES = '/Developer/usr/lib/libMainThreadChecker.dylib';
      appEnv.OS_ACTIVITY_DT_MODE = 'YES';
    }
    const appArgs = ['-NSTreatUnknownArgumentsAsOpen', 'NO', '-ApplePersistenceIgnoreState', 'YES'];
    const appOptions = {
      StartSuspendedKey: false
    };
    if (majorVersion >= MAJOR_IOS_VERSION_12) {
      appOptions.ActivateSuspended = true;
    }
    const launchResult = await this._instrumentService.callChannel(PROCESS_CONTROL, 'launchSuspendedProcessWithDevicePath:bundleIdentifier:environment:arguments:options:', appPath, this.xctestBundleId, appEnv, appArgs, appOptions);
    const pid = launchResult.selector;
    if (typeof pid !== 'number') {
      throw new Error(`Failed on launching ${this.xctestBundleId}: ${launchResult}`);
    }
    _logger.default.info(`Pid of launched ${this.xctestBundleId}: ${pid}`);
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(pid);
    await this._instrumentService.callChannel(PROCESS_CONTROL, 'startObservingPid:', msg);
    return pid;
  }
  async _writeConfigurationToDevice(xctestConfiguration, xctestPath) {
    const xctestContent = xctestConfiguration.getBytes();
    const houseArrestService = await (0, _services.startHouseArrestService)(this.udid);
    let vendContainer;
    let stream;
    try {
      vendContainer = await houseArrestService.vendContainer(this.xctestBundleId);
      const list = await vendContainer.listDirectory(TMP_FOLDER_PREFIX);
      for (const file of list) {
        if (file.endsWith(XCTEST_CONFIGURATION_EXTENSION)) {
          const fullPath = `${TMP_FOLDER_PREFIX}/${file}`;
          _logger.default.debug(`removing ${fullPath}`);
          await vendContainer.deleteDirectory(fullPath);
        }
      }
      stream = await vendContainer.createWriteStream(xctestPath, {});
      await new _bluebird.default((resolve, reject) => {
        stream.write(xctestContent, resolve);
        stream.on('error', reject);
      });
    } finally {
      var _stream, _vendContainer;
      (_stream = stream) === null || _stream === void 0 ? void 0 : _stream.end();
      (_vendContainer = vendContainer) === null || _vendContainer === void 0 ? void 0 : _vendContainer.close();
      houseArrestService.close();
    }
  }
  async _startInitialSession(majorVersion) {
    this._initialControlSession = await (0, _services.startTestmanagerdService)(this.udid);
    this._initialControlSession.registerLifecycleCallback('close', this.stop.bind(this));
    if (majorVersion < MAJOR_IOS_VERSION_11) {
      return;
    }
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(XCODE_VERSION);
    await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionWithProtocolVersion:', msg);
  }
  async _startExecSession(sessionIdentifier) {
    this._execTestPlanSession = await (0, _services.startTestmanagerdService)(this.udid);
    this._execTestPlanSession.registerLifecycleCallback('close', this.stop.bind(this));
    const startExecuting = () => {
      if (this._executing) {
        return;
      }
      this._executing = true;
      const msg = new _headers.DTXMessageAuxBuffer();
      msg.appendObject(XCODE_VERSION);
      this._execTestPlanSession._callChannel(false, MAGIC_CHANNEL, '_IDE_startExecutingTestPlanWithProtocolVersion:', msg);
    };
    const showLogMessage = message => {
      if (message.auxiliaries.join('').includes('Received test runner ready reply with error: (null')) {
        _logger.default.info('Test runner ready');
        setTimeout(() => startExecuting(), 1000);
      }
    };
    this._execTestPlanSession.registerSelectorCallback('_XCT_testBundleReadyWithProtocolVersion:minimumVersion:', startExecuting);
    this._execTestPlanSession.registerSelectorCallback('_XCT_logDebugMessage:', showLogMessage);
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(new _nskeyed.NSUUID(sessionIdentifier));
    msg.appendObject(`${sessionIdentifier}-746F-006D726964646C79`);
    msg.appendObject(XCODE_BUILD_PATH);
    msg.appendObject(XCODE_VERSION);
    await this._execTestPlanSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateSessionWithIdentifier:forClient:atPath:protocolVersion:', msg);
  }
  async _notifyTestProcessId(pid, majorVersion) {
    const msg = new _headers.DTXMessageAuxBuffer();
    msg.appendObject(pid);
    if (majorVersion >= MAJOR_IOS_VERSION_12) {
      return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_authorizeTestSessionWithProcessID:', msg);
    }
    if (majorVersion <= MAJOR_IOS_VERSION_9) {
      return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionForTestProcessID:', msg);
    }
    msg.appendObject(XCODE_VERSION);
    return await this._initialControlSession.callChannel(DAEMON_CONNECTION_INTERFACE, '_IDE_initiateControlSessionForTestProcessID:protocolVersion:', msg);
  }
  async start() {
    if (this.running) {
      const targetMessage = this.targetBundleId ? `(targeting ${this.targetBundleId})` : '';
      const message = `Xctest for ${this.xctestBundleId}${targetMessage} on device ${this.udid} is already running!`;
      _logger.default.info(`${message} Doing nothing here`);
      return;
    }
    this.running = true;
    try {
      const productVersion = await (0, _utilities.getOSVersion)(this.udid);
      const majorVersion = parseInt(productVersion.split('.')[0], 10);
      const sessionIdentifier = _support.util.uuidV4();
      await this._startInitialSession(majorVersion);
      await this._startExecSession(sessionIdentifier);
      const pid = await this._launchAppRunner(majorVersion, sessionIdentifier);
      await this._notifyTestProcessId(pid, majorVersion);
    } catch (e) {
      this.stop();
      throw e;
    }
  }
  stop() {
    var _this$_instrumentServ, _this$_instrumentServ2, _this$_execTestPlanSe, _this$_execTestPlanSe2, _this$_initialControl, _this$_initialControl2;
    if (!this.running) {
      return;
    }
    this.running = false;
    (_this$_instrumentServ = this._instrumentService) === null || _this$_instrumentServ === void 0 ? void 0 : _this$_instrumentServ.close();
    (_this$_instrumentServ2 = this._instrumentService) === null || _this$_instrumentServ2 === void 0 ? void 0 : _this$_instrumentServ2.dispose();
    this._instrumentService = undefined;
    (_this$_execTestPlanSe = this._execTestPlanSession) === null || _this$_execTestPlanSe === void 0 ? void 0 : _this$_execTestPlanSe.close();
    (_this$_execTestPlanSe2 = this._execTestPlanSession) === null || _this$_execTestPlanSe2 === void 0 ? void 0 : _this$_execTestPlanSe2.dispose();
    this._execTestPlanSession = undefined;
    (_this$_initialControl = this._initialControlSession) === null || _this$_initialControl === void 0 ? void 0 : _this$_initialControl.close();
    (_this$_initialControl2 = this._initialControlSession) === null || _this$_initialControl2 === void 0 ? void 0 : _this$_initialControl2.dispose();
    this._initialControlSession = undefined;
    this._executing = false;
    const targetMessage = this.targetBundleId ? `(targeting ${this.targetBundleId})` : '';
    const message = `Xctest for ${this.xctestBundleId}${targetMessage} on device ${this.udid} has stopped!`;
    _logger.default.debug(message);
  }
}
exports.Xctest = Xctest;
var _default = Xctest;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfc2VydmljZXMiLCJyZXF1aXJlIiwiX2luc3RydW1lbnQiLCJfaGVhZGVycyIsIl9uc2tleWVkIiwiX3Rlc3RtYW5hZ2VyZCIsIl9zdXBwb3J0IiwiX3V0aWxpdGllcyIsIl9sb2dnZXIiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwiX2JsdWViaXJkIiwiREFFTU9OX0NPTk5FQ1RJT05fSU5URVJGQUNFIiwiVEVTVE1BTkFHRVJEX0NIQU5ORUwiLCJYQ1RFU1RfQ09ORklHVVJBVElPTl9FWFRFTlNJT04iLCJUTVBfRk9MREVSX1BSRUZJWCIsIlhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCIsIk1BSk9SX0lPU19WRVJTSU9OXzkiLCJNQUpPUl9JT1NfVkVSU0lPTl8xMSIsIk1BSk9SX0lPU19WRVJTSU9OXzEyIiwiWENPREVfQlVJTERfUEFUSCIsIlhDT0RFX1ZFUlNJT04iLCJNQUdJQ19DSEFOTkVMIiwiWGN0ZXN0IiwiY29uc3RydWN0b3IiLCJ1ZGlkIiwieGN0ZXN0QnVuZGxlSWQiLCJ0YXJnZXRCdW5kbGVJZCIsIm9wdHMiLCJydW5uaW5nIiwiX2V4ZWN1dGluZyIsIl9jb25mIiwiY29uZiIsIl9lbnYiLCJlbnYiLCJfbGF1bmNoQXBwUnVubmVyIiwibWFqb3JWZXJzaW9uIiwic2Vzc2lvbklkZW50aWZpZXIiLCJQUk9DRVNTX0NPTlRST0wiLCJJTlNUUlVNRU5UX0NIQU5ORUwiLCJpbnN0YWxsYXRpb24iLCJzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSIsImxvb2t1cFJlc3VsdCIsImxvb2t1cEFwcGxpY2F0aW9ucyIsImJ1bmRsZUlkcyIsImNsb3NlIiwiYXBwSW5mbyIsIkVycm9yIiwic2lnbmVySWRlbnRpZmllciIsIlNpZ25lcklkZW50aXR5IiwibG9nIiwiaW5mbyIsImFwcENvbnRhaW5lciIsIkNvbnRhaW5lciIsImV4ZWNOYW1lIiwiQ0ZCdW5kbGVFeGVjdXRhYmxlIiwiZW5kc1dpdGgiLCJ0YXJnZXROYW1lIiwic3Vic3RyIiwiaW5kZXhPZiIsInhjdGVzdFBhdGgiLCJ0b1VwcGVyQ2FzZSIsInhjdGVzdENvbmZpZ3VyYXRpb24iLCJYQ1Rlc3RDb25maWd1cmF0aW9uIiwidGVzdEJ1bmRsZVVSTCIsIlBhdGgiLCJ0YXJnZXRBcHBsaWNhdGlvbkJ1bmRsZUlEIiwiX3dyaXRlQ29uZmlndXJhdGlvblRvRGV2aWNlIiwiX2luc3RydW1lbnRTZXJ2aWNlIiwic3RhcnRJbnN0cnVtZW50U2VydmljZSIsInJlZ2lzdGVyTGlmZWN5Y2xlQ2FsbGJhY2siLCJzdG9wIiwiYmluZCIsImNhbGxDaGFubmVsIiwiYXBwUGF0aCIsInhjdGVzdENvbmZpZ3VyYXRpb25QYXRoIiwiYXBwRW52IiwiQ0FfQVNTRVJUX01BSU5fVEhSRUFEX1RSQU5TQUNUSU9OUyIsIkNBX0RFQlVHX1RSQU5TQUNUSU9OUyIsIkRZTERfRlJBTUVXT1JLX1BBVEgiLCJEWUxEX0xJQlJBUllfUEFUSCIsIk5TVW5idWZmZXJlZElPIiwiU1FMSVRFX0VOQUJMRV9USFJFQURfQVNTRVJUSU9OUyIsIldEQV9QUk9EVUNUX0JVTkRMRV9JREVOVElGSUVSIiwiWENUZXN0Q29uZmlndXJhdGlvbkZpbGVQYXRoIiwiWENPREVfREJHX1hQQ19FWENMVVNJT05TIiwiTUpQRUdfU0VSVkVSX1BPUlQiLCJVU0VfUE9SVCIsIkxMVk1fUFJPRklMRV9GSUxFIiwiRFlMRF9JTlNFUlRfTElCUkFSSUVTIiwiT1NfQUNUSVZJVFlfRFRfTU9ERSIsImFwcEFyZ3MiLCJhcHBPcHRpb25zIiwiU3RhcnRTdXNwZW5kZWRLZXkiLCJBY3RpdmF0ZVN1c3BlbmRlZCIsImxhdW5jaFJlc3VsdCIsInBpZCIsInNlbGVjdG9yIiwibXNnIiwiRFRYTWVzc2FnZUF1eEJ1ZmZlciIsImFwcGVuZE9iamVjdCIsInhjdGVzdENvbnRlbnQiLCJnZXRCeXRlcyIsImhvdXNlQXJyZXN0U2VydmljZSIsInN0YXJ0SG91c2VBcnJlc3RTZXJ2aWNlIiwidmVuZENvbnRhaW5lciIsInN0cmVhbSIsImxpc3QiLCJsaXN0RGlyZWN0b3J5IiwiZmlsZSIsImZ1bGxQYXRoIiwiZGVidWciLCJkZWxldGVEaXJlY3RvcnkiLCJjcmVhdGVXcml0ZVN0cmVhbSIsIkIiLCJyZXNvbHZlIiwicmVqZWN0Iiwid3JpdGUiLCJvbiIsIl9zdHJlYW0iLCJfdmVuZENvbnRhaW5lciIsImVuZCIsIl9zdGFydEluaXRpYWxTZXNzaW9uIiwiX2luaXRpYWxDb250cm9sU2Vzc2lvbiIsInN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSIsIl9zdGFydEV4ZWNTZXNzaW9uIiwiX2V4ZWNUZXN0UGxhblNlc3Npb24iLCJzdGFydEV4ZWN1dGluZyIsIl9jYWxsQ2hhbm5lbCIsInNob3dMb2dNZXNzYWdlIiwibWVzc2FnZSIsImF1eGlsaWFyaWVzIiwiam9pbiIsImluY2x1ZGVzIiwic2V0VGltZW91dCIsInJlZ2lzdGVyU2VsZWN0b3JDYWxsYmFjayIsIk5TVVVJRCIsIl9ub3RpZnlUZXN0UHJvY2Vzc0lkIiwic3RhcnQiLCJ0YXJnZXRNZXNzYWdlIiwicHJvZHVjdFZlcnNpb24iLCJnZXRPU1ZlcnNpb24iLCJwYXJzZUludCIsInNwbGl0IiwidXRpbCIsInV1aWRWNCIsImUiLCJfdGhpcyRfaW5zdHJ1bWVudFNlcnYiLCJfdGhpcyRfaW5zdHJ1bWVudFNlcnYyIiwiX3RoaXMkX2V4ZWNUZXN0UGxhblNlIiwiX3RoaXMkX2V4ZWNUZXN0UGxhblNlMiIsIl90aGlzJF9pbml0aWFsQ29udHJvbCIsIl90aGlzJF9pbml0aWFsQ29udHJvbDIiLCJkaXNwb3NlIiwidW5kZWZpbmVkIiwiZXhwb3J0cyIsIl9kZWZhdWx0IiwiZGVmYXVsdCJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi94Y3Rlc3QuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UsIHN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSwgc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UsIHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UgfSBmcm9tICcuL3NlcnZpY2VzJztcbmltcG9ydCB7IElOU1RSVU1FTlRfQ0hBTk5FTCB9IGZyb20gJy4vaW5zdHJ1bWVudCc7XG5pbXBvcnQgeyBEVFhNZXNzYWdlQXV4QnVmZmVyIH0gZnJvbSAnLi9pbnN0cnVtZW50L2hlYWRlcnMnO1xuaW1wb3J0IHsgTlNVVUlELCBYQ1Rlc3RDb25maWd1cmF0aW9uIH0gZnJvbSAnLi9pbnN0cnVtZW50L3RyYW5zZm9ybWVyL25za2V5ZWQnO1xuaW1wb3J0IHsgVEVTVE1BTkFHRVJEX0NIQU5ORUwgfSBmcm9tICcuL3Rlc3RtYW5hZ2VyZCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGdldE9TVmVyc2lvbiB9IGZyb20gJy4vdXRpbGl0aWVzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5jb25zdCB7IERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSB9ID0gVEVTVE1BTkFHRVJEX0NIQU5ORUw7XG5jb25zdCBYQ1RFU1RfQ09ORklHVVJBVElPTl9FWFRFTlNJT04gPSAnLnhjdGVzdGNvbmZpZ3VyYXRpb24nO1xuY29uc3QgVE1QX0ZPTERFUl9QUkVGSVggPSAnL3RtcCc7XG5jb25zdCBYQ1RFU1RfRVhFQ1VUQUJMRV9TVUZGSVggPSAnLVJ1bm5lcic7XG5jb25zdCBNQUpPUl9JT1NfVkVSU0lPTl85ID0gOTtcbmNvbnN0IE1BSk9SX0lPU19WRVJTSU9OXzExID0gMTE7XG5jb25zdCBNQUpPUl9JT1NfVkVSU0lPTl8xMiA9IDEyO1xuLy9UaGlzIGlzIG5vdCByZWxhdGVkIHdpdGggd2hpY2ggeGNvZGUgdXNlciBpbnN0YWxsZWQgYnV0IG9ubHkgYSBtYXJrZXIgdG8gdXNlIGluc2lkZSBkZXZpY2VcbmNvbnN0IFhDT0RFX0JVSUxEX1BBVEggPSAnL0FwcGxpY2F0aW9ucy9YY29kZS5hcHAvQ29udGVudHMvRGV2ZWxvcGVyL3Vzci9iaW4veGNvZGVidWlsZCc7XG5jb25zdCBYQ09ERV9WRVJTSU9OID0gMjk7XG5jb25zdCBNQUdJQ19DSEFOTkVMID0gMHhGRkZGRkZGRjtcbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gWENUZXN0Q29uZmlndXJhdGlvblByb3BlcnRpZXNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gcHJvZHVjdE1vZHVsZU5hbWVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nW10/fSB0YXJnZXRBcHBsaWNhdGlvbkFyZ3VtZW50c1xuICogQHByb3BlcnR5IHtzdHJpbmdbXT99IHRlc3RzVG9SdW5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nW10/fSB0ZXN0c1RvU2tpcFxuICovXG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gWGN0ZXN0T3B0aW9uXG4gKiBAcHJvcGVydHkge1hDVGVzdENvbmZpZ3VyYXRpb25Qcm9wZXJ0aWVzfSBjb25mIHByb3BlcnRpZXMgdG8gb3ZlcnJpZGUgaW4gWENUZXN0Q29uZmlndXJhdGlvblxuICogQHByb3BlcnR5IHtvYmplY3R9IGVudiBrZXktdmFsdWUgcGFpcnMgdG8gYXBwZW5kIGluIHhjdGVzdCBhcHAgZW52aXJvbm1lbnRcbiAqL1xuXG4vKipcbiAqIEFsbG93cyBpbnZva2luZyBwcmUtaW5zdGFsbGVkIHhjdGVzdCBhcHAgZnJvbSBpT1MgZGV2aWNlcy4gTm8gWGNvZGUgaW5zdGFsbGF0aW9uIGlzIHJlcXVpcmVkLlxuICogVGhpcyBjbGFzcyBzaW11bGF0ZXMgdGhlIHByb2NlZHVyZSB3aGljaCB4Y29kZSB1c2VzIHRvIGludm9rZSB4Y3Rlc3RzLlxuICovXG5jbGFzcyBYY3Rlc3Qge1xuXG4gICAgLyoqXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgRGV2aWNlIHVkaWQuXG4gICAgICogQHBhcmFtIHtzdHJpbmd9IHhjdGVzdEJ1bmRsZUlkIEJ1bmRsZSBJZCBvZiB4Y3Rlc3QgYXBwIG9uIGRldmljZS4gVGhlIGFwcCBtdXN0IGJlIGluc3RhbGxlZCBvbiBkZXZpY2UuXG4gICAgICogQHBhcmFtIHtzdHJpbmc/fSB0YXJnZXRCdW5kbGVJZCB0ZXN0IHRhcmdldCBidW5kbGUgaWQuXG4gICAgICogQHBhcmFtIHtYY3Rlc3RPcHRpb24/fSBvcHRzIGFkZGl0aW9uIG9wdGlvbnMgdG8gc3BlY2lmaWMgWENUZXN0Q29uZmlndXJhdGlvbiBhbmQgYXBwIGxhdW5jaCBlbnZcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcih1ZGlkLCB4Y3Rlc3RCdW5kbGVJZCwgdGFyZ2V0QnVuZGxlSWQgPSBudWxsLCBvcHRzID0ge30pIHtcbiAgICAgICAgdGhpcy51ZGlkID0gdWRpZDtcbiAgICAgICAgdGhpcy5ydW5uaW5nID0gZmFsc2U7XG4gICAgICAgIHRoaXMuX2V4ZWN1dGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLnhjdGVzdEJ1bmRsZUlkID0geGN0ZXN0QnVuZGxlSWQ7XG4gICAgICAgIHRoaXMudGFyZ2V0QnVuZGxlSWQgPSB0YXJnZXRCdW5kbGVJZDtcbiAgICAgICAgdGhpcy5fY29uZiA9IG9wdHM/LmNvbmYgfHwge307XG4gICAgICAgIHRoaXMuX2VudiA9IG9wdHM/LmVudiB8fCB7fTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gbWFqb3JWZXJzaW9uIGZpcnN0IHBhcnQgb2YgaU9TIHZlcnNpb24gOS8xMC8xMS8xMi8xMy8xNC8xNS8xNlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWRlbnRpZmllciB1dWlkIHdpdGggZm9ybWF0OiAwMDAwMDAwMC0wMDAwLTAwMDAtMDAwMC0wMDAwMDAwMDAwMDBcbiAgICAgKi9cbiAgICBhc3luYyBfbGF1bmNoQXBwUnVubmVyKG1ham9yVmVyc2lvbiwgc2Vzc2lvbklkZW50aWZpZXIpIHtcbiAgICAgICAgY29uc3QgeyBQUk9DRVNTX0NPTlRST0wgfSA9IElOU1RSVU1FTlRfQ0hBTk5FTDtcbiAgICAgICAgY29uc3QgaW5zdGFsbGF0aW9uID0gYXdhaXQgc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgICAgbGV0IGxvb2t1cFJlc3VsdDtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGxvb2t1cFJlc3VsdCA9IGF3YWl0IGluc3RhbGxhdGlvbi5sb29rdXBBcHBsaWNhdGlvbnMoeyBidW5kbGVJZHM6IFt0aGlzLnhjdGVzdEJ1bmRsZUlkXSB9KTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIGluc3RhbGxhdGlvbi5jbG9zZSgpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGFwcEluZm8gPSBsb29rdXBSZXN1bHRbdGhpcy54Y3Rlc3RCdW5kbGVJZF07XG4gICAgICAgIGlmICghYXBwSW5mbykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3RoaXMueGN0ZXN0QnVuZGxlSWR9IG5vdCBmb3VuZCBvbiBkZXZpY2UgJHt0aGlzLnVkaWR9YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3Qgc2lnbmVySWRlbnRpZmllciA9IGFwcEluZm8uU2lnbmVySWRlbnRpdHk7XG4gICAgICAgIGxvZy5pbmZvKGBTaWduZXJJZGVudGlmaWVyOiAke3NpZ25lcklkZW50aWZpZXJ9YCk7XG4gICAgICAgIGNvbnN0IGFwcENvbnRhaW5lciA9IGFwcEluZm8uQ29udGFpbmVyO1xuICAgICAgICBjb25zdCBleGVjTmFtZSA9IGFwcEluZm8uQ0ZCdW5kbGVFeGVjdXRhYmxlO1xuICAgICAgICBpZiAoIWV4ZWNOYW1lLmVuZHNXaXRoKFhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCkpIHtcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBDRkJ1bmRsZUV4ZWN1dGFibGUgJHtleGVjTmFtZX0gZnJvbSAke3RoaXMueGN0ZXN0QnVuZGxlSWR9LCBpcyB0aGlzIGJ1bmRsZSBhIHZhbGlkIHhjdGVzdCBhcHA/YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdGFyZ2V0TmFtZSA9IGV4ZWNOYW1lLnN1YnN0cigwLCBleGVjTmFtZS5pbmRleE9mKFhDVEVTVF9FWEVDVVRBQkxFX1NVRkZJWCkpO1xuICAgICAgICBjb25zdCB4Y3Rlc3RQYXRoID0gYCR7VE1QX0ZPTERFUl9QUkVGSVh9LyR7dGFyZ2V0TmFtZX0tJHtzZXNzaW9uSWRlbnRpZmllci50b1VwcGVyQ2FzZSgpfSR7WENURVNUX0NPTkZJR1VSQVRJT05fRVhURU5TSU9OfWA7XG4gICAgICAgIGNvbnN0IHhjdGVzdENvbmZpZ3VyYXRpb24gPSBuZXcgWENUZXN0Q29uZmlndXJhdGlvbih7XG4gICAgICAgICAgICAuLi50aGlzLl9jb25mLFxuICAgICAgICAgICAgLy8gcHJvcGVydGllcyBiZWxvdyBzaG91bGQgbm90IGJlIG92ZXJyaWRlXG4gICAgICAgICAgICB0ZXN0QnVuZGxlVVJMOiBgZmlsZTovLyR7YXBwSW5mby5QYXRofS9QbHVnSW5zLyR7dGFyZ2V0TmFtZX0ueGN0ZXN0YCxcbiAgICAgICAgICAgIHNlc3Npb25JZGVudGlmaWVyLFxuICAgICAgICAgICAgdGFyZ2V0QXBwbGljYXRpb25CdW5kbGVJRDogdGhpcy50YXJnZXRCdW5kbGVJZCxcbiAgICAgICAgfSk7XG4gICAgICAgIGF3YWl0IHRoaXMuX3dyaXRlQ29uZmlndXJhdGlvblRvRGV2aWNlKHhjdGVzdENvbmZpZ3VyYXRpb24sIHhjdGVzdFBhdGgpO1xuICAgICAgICB0aGlzLl9pbnN0cnVtZW50U2VydmljZSA9IGF3YWl0IHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICAgICAgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UucmVnaXN0ZXJMaWZlY3ljbGVDYWxsYmFjaygnY2xvc2UnLCB0aGlzLnN0b3AuYmluZCh0aGlzKSk7XG4gICAgICAgIGF3YWl0IHRoaXMuX2luc3RydW1lbnRTZXJ2aWNlLmNhbGxDaGFubmVsKFBST0NFU1NfQ09OVFJPTCwgJ3Byb2Nlc3NJZGVudGlmaWVyRm9yQnVuZGxlSWRlbnRpZmllcjonLCB0aGlzLnhjdGVzdEJ1bmRsZUlkKTtcbiAgICAgICAgY29uc3QgYXBwUGF0aCA9IGFwcEluZm8uUGF0aDtcbiAgICAgICAgY29uc3QgeGN0ZXN0Q29uZmlndXJhdGlvblBhdGggPSBhcHBDb250YWluZXIgKyB4Y3Rlc3RQYXRoO1xuICAgICAgICBjb25zdCBhcHBFbnYgPSB7XG4gICAgICAgICAgICBDQV9BU1NFUlRfTUFJTl9USFJFQURfVFJBTlNBQ1RJT05TOiAnMCcsXG4gICAgICAgICAgICBDQV9ERUJVR19UUkFOU0FDVElPTlM6ICcwJyxcbiAgICAgICAgICAgIERZTERfRlJBTUVXT1JLX1BBVEg6IGAke2FwcFBhdGh9L0ZyYW1ld29ya3M6YCxcbiAgICAgICAgICAgIERZTERfTElCUkFSWV9QQVRIOiBgJHthcHBQYXRofS9GcmFtZXdvcmtzYCxcbiAgICAgICAgICAgIE5TVW5idWZmZXJlZElPOiAnWUVTJyxcbiAgICAgICAgICAgIFNRTElURV9FTkFCTEVfVEhSRUFEX0FTU0VSVElPTlM6ICcxJyxcbiAgICAgICAgICAgIFdEQV9QUk9EVUNUX0JVTkRMRV9JREVOVElGSUVSOiAnJyxcbiAgICAgICAgICAgIFhDVGVzdENvbmZpZ3VyYXRpb25GaWxlUGF0aDogeGN0ZXN0Q29uZmlndXJhdGlvblBhdGgsXG4gICAgICAgICAgICBYQ09ERV9EQkdfWFBDX0VYQ0xVU0lPTlM6ICdjb20uYXBwbGUuZHQueGN0ZXN0U3ltYm9saWNhdG9yJyxcbiAgICAgICAgICAgIE1KUEVHX1NFUlZFUl9QT1JUOiAnJyxcbiAgICAgICAgICAgIFVTRV9QT1JUOiAnJyxcbiAgICAgICAgICAgIC8vICVwIG1lYW5zIHBpZFxuICAgICAgICAgICAgTExWTV9QUk9GSUxFX0ZJTEU6IGAke2FwcENvbnRhaW5lcn0vdG1wLyVwLnByb2ZyYXdgLFxuICAgICAgICAgICAgLi4udGhpcy5fZW52XG4gICAgICAgIH07XG4gICAgICAgIGlmIChtYWpvclZlcnNpb24gPj0gTUFKT1JfSU9TX1ZFUlNJT05fMTEpIHtcbiAgICAgICAgICAgIGFwcEVudi5EWUxEX0lOU0VSVF9MSUJSQVJJRVMgPSAnL0RldmVsb3Blci91c3IvbGliL2xpYk1haW5UaHJlYWRDaGVja2VyLmR5bGliJztcbiAgICAgICAgICAgIGFwcEVudi5PU19BQ1RJVklUWV9EVF9NT0RFID0gJ1lFUyc7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgYXBwQXJncyA9IFtcbiAgICAgICAgICAgICctTlNUcmVhdFVua25vd25Bcmd1bWVudHNBc09wZW4nLCAnTk8nLFxuICAgICAgICAgICAgJy1BcHBsZVBlcnNpc3RlbmNlSWdub3JlU3RhdGUnLCAnWUVTJ1xuICAgICAgICBdO1xuICAgICAgICBjb25zdCBhcHBPcHRpb25zID0geyBTdGFydFN1c3BlbmRlZEtleTogZmFsc2UgfTtcbiAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+PSBNQUpPUl9JT1NfVkVSU0lPTl8xMikge1xuICAgICAgICAgICAgYXBwT3B0aW9ucy5BY3RpdmF0ZVN1c3BlbmRlZCA9IHRydWU7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbGF1bmNoUmVzdWx0ID0gYXdhaXQgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UuY2FsbENoYW5uZWwoUFJPQ0VTU19DT05UUk9MLFxuICAgICAgICAgICAgJ2xhdW5jaFN1c3BlbmRlZFByb2Nlc3NXaXRoRGV2aWNlUGF0aDpidW5kbGVJZGVudGlmaWVyOmVudmlyb25tZW50OmFyZ3VtZW50czpvcHRpb25zOicsXG4gICAgICAgICAgICBhcHBQYXRoLCB0aGlzLnhjdGVzdEJ1bmRsZUlkLCBhcHBFbnYsIGFwcEFyZ3MsIGFwcE9wdGlvbnMpO1xuICAgICAgICBjb25zdCBwaWQgPSBsYXVuY2hSZXN1bHQuc2VsZWN0b3I7XG4gICAgICAgIGlmICh0eXBlb2YgcGlkICE9PSAnbnVtYmVyJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgb24gbGF1bmNoaW5nICR7dGhpcy54Y3Rlc3RCdW5kbGVJZH06ICR7bGF1bmNoUmVzdWx0fWApO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBQaWQgb2YgbGF1bmNoZWQgJHt0aGlzLnhjdGVzdEJ1bmRsZUlkfTogJHtwaWR9YCk7XG4gICAgICAgIGNvbnN0IG1zZyA9IG5ldyBEVFhNZXNzYWdlQXV4QnVmZmVyKCk7XG4gICAgICAgIG1zZy5hcHBlbmRPYmplY3QocGlkKTtcbiAgICAgICAgYXdhaXQgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2UuY2FsbENoYW5uZWwoUFJPQ0VTU19DT05UUk9MLCAnc3RhcnRPYnNlcnZpbmdQaWQ6JywgbXNnKTtcbiAgICAgICAgcmV0dXJuIHBpZDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge1hDVGVzdENvbmZpZ3VyYXRpb259IHhjdGVzdENvbmZpZ3VyYXRpb24gcGxpc3QgY29udGFpbnNcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30geGN0ZXN0UGF0aCB3aGVyZSB4Y3Rlc3RDb25maWd1cmF0aW9uIHNob3VsZCBiZSBwbGFjZSBpbiBhcHAgc2FuZGJveC5cbiAgICAgKi9cbiAgICBhc3luYyBfd3JpdGVDb25maWd1cmF0aW9uVG9EZXZpY2UoeGN0ZXN0Q29uZmlndXJhdGlvbiwgeGN0ZXN0UGF0aCkge1xuICAgICAgICBjb25zdCB4Y3Rlc3RDb250ZW50ID0geGN0ZXN0Q29uZmlndXJhdGlvbi5nZXRCeXRlcygpO1xuICAgICAgICBjb25zdCBob3VzZUFycmVzdFNlcnZpY2UgPSBhd2FpdCBzdGFydEhvdXNlQXJyZXN0U2VydmljZSh0aGlzLnVkaWQpO1xuICAgICAgICBsZXQgdmVuZENvbnRhaW5lcjtcbiAgICAgICAgbGV0IHN0cmVhbTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHZlbmRDb250YWluZXIgPSBhd2FpdCBob3VzZUFycmVzdFNlcnZpY2UudmVuZENvbnRhaW5lcih0aGlzLnhjdGVzdEJ1bmRsZUlkKTtcbiAgICAgICAgICAgIGNvbnN0IGxpc3QgPSBhd2FpdCB2ZW5kQ29udGFpbmVyLmxpc3REaXJlY3RvcnkoVE1QX0ZPTERFUl9QUkVGSVgpO1xuICAgICAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIGxpc3QpIHtcbiAgICAgICAgICAgICAgICBpZiAoZmlsZS5lbmRzV2l0aChYQ1RFU1RfQ09ORklHVVJBVElPTl9FWFRFTlNJT04pKSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gYCR7VE1QX0ZPTERFUl9QUkVGSVh9LyR7ZmlsZX1gO1xuICAgICAgICAgICAgICAgICAgICBsb2cuZGVidWcoYHJlbW92aW5nICR7ZnVsbFBhdGh9YCk7XG4gICAgICAgICAgICAgICAgICAgIGF3YWl0IHZlbmRDb250YWluZXIuZGVsZXRlRGlyZWN0b3J5KGZ1bGxQYXRoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzdHJlYW0gPSBhd2FpdCB2ZW5kQ29udGFpbmVyLmNyZWF0ZVdyaXRlU3RyZWFtKHhjdGVzdFBhdGgsIHt9KTtcbiAgICAgICAgICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBzdHJlYW0ud3JpdGUoeGN0ZXN0Q29udGVudCwgcmVzb2x2ZSk7XG4gICAgICAgICAgICAgICAgc3RyZWFtLm9uKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICAgIHN0cmVhbT8uZW5kKCk7XG4gICAgICAgICAgICB2ZW5kQ29udGFpbmVyPy5jbG9zZSgpO1xuICAgICAgICAgICAgaG91c2VBcnJlc3RTZXJ2aWNlLmNsb3NlKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBhc3luYyBfc3RhcnRJbml0aWFsU2Vzc2lvbihtYWpvclZlcnNpb24pIHtcbiAgICAgICAgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uID0gYXdhaXQgc3RhcnRUZXN0bWFuYWdlcmRTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgICAgIHRoaXMuX2luaXRpYWxDb250cm9sU2Vzc2lvbi5yZWdpc3RlckxpZmVjeWNsZUNhbGxiYWNrKCdjbG9zZScsIHRoaXMuc3RvcC5iaW5kKHRoaXMpKTtcbiAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA8IE1BSk9SX0lPU19WRVJTSU9OXzExKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgbXNnID0gbmV3IERUWE1lc3NhZ2VBdXhCdWZmZXIoKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChYQ09ERV9WRVJTSU9OKTtcbiAgICAgICAgYXdhaXQgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uLmNhbGxDaGFubmVsKERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSxcbiAgICAgICAgICAgICdfSURFX2luaXRpYXRlQ29udHJvbFNlc3Npb25XaXRoUHJvdG9jb2xWZXJzaW9uOicsIG1zZyk7XG4gICAgfVxuXG4gICAgYXN5bmMgX3N0YXJ0RXhlY1Nlc3Npb24oc2Vzc2lvbklkZW50aWZpZXIpIHtcbiAgICAgICAgdGhpcy5fZXhlY1Rlc3RQbGFuU2Vzc2lvbiA9IGF3YWl0IHN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSh0aGlzLnVkaWQpO1xuICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uLnJlZ2lzdGVyTGlmZWN5Y2xlQ2FsbGJhY2soJ2Nsb3NlJywgdGhpcy5zdG9wLmJpbmQodGhpcykpO1xuICAgICAgICBjb25zdCBzdGFydEV4ZWN1dGluZyA9ICgpID0+IHtcbiAgICAgICAgICAgIGlmICh0aGlzLl9leGVjdXRpbmcpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl9leGVjdXRpbmcgPSB0cnVlO1xuICAgICAgICAgICAgY29uc3QgbXNnID0gbmV3IERUWE1lc3NhZ2VBdXhCdWZmZXIoKTtcbiAgICAgICAgICAgIG1zZy5hcHBlbmRPYmplY3QoWENPREVfVkVSU0lPTik7XG4gICAgICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uLl9jYWxsQ2hhbm5lbChmYWxzZSwgTUFHSUNfQ0hBTk5FTCwgJ19JREVfc3RhcnRFeGVjdXRpbmdUZXN0UGxhbldpdGhQcm90b2NvbFZlcnNpb246JywgbXNnKTtcbiAgICAgICAgfTtcbiAgICAgICAgY29uc3Qgc2hvd0xvZ01lc3NhZ2UgPSAobWVzc2FnZSkgPT4ge1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2UuYXV4aWxpYXJpZXMuam9pbignJykuaW5jbHVkZXMoJ1JlY2VpdmVkIHRlc3QgcnVubmVyIHJlYWR5IHJlcGx5IHdpdGggZXJyb3I6IChudWxsJykpIHtcbiAgICAgICAgICAgICAgICBsb2cuaW5mbygnVGVzdCBydW5uZXIgcmVhZHknKTtcbiAgICAgICAgICAgICAgICAvL0EgbWFnaWMgdGhpbmcgaXMgdGhhdCBpZiBub3QgdXNpbmcgYSBkZWxheSB0aGlzIHdvdWxkIGZhaWwgb24gaVBob25lNyBpT1MgMTMuNi4xXG4gICAgICAgICAgICAgICAgc2V0VGltZW91dCgoKSA9PiBzdGFydEV4ZWN1dGluZygpLCAxMDAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fZXhlY1Rlc3RQbGFuU2Vzc2lvbi5yZWdpc3RlclNlbGVjdG9yQ2FsbGJhY2soJ19YQ1RfdGVzdEJ1bmRsZVJlYWR5V2l0aFByb3RvY29sVmVyc2lvbjptaW5pbXVtVmVyc2lvbjonLCBzdGFydEV4ZWN1dGluZyk7XG4gICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24ucmVnaXN0ZXJTZWxlY3RvckNhbGxiYWNrKCdfWENUX2xvZ0RlYnVnTWVzc2FnZTonLCBzaG93TG9nTWVzc2FnZSk7XG4gICAgICAgIGNvbnN0IG1zZyA9IG5ldyBEVFhNZXNzYWdlQXV4QnVmZmVyKCk7XG4gICAgICAgIG1zZy5hcHBlbmRPYmplY3QobmV3IE5TVVVJRChzZXNzaW9uSWRlbnRpZmllcikpO1xuICAgICAgICBtc2cuYXBwZW5kT2JqZWN0KGAke3Nlc3Npb25JZGVudGlmaWVyfS03NDZGLTAwNkQ3MjY5NjQ2NDZDNzlgKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChYQ09ERV9CVUlMRF9QQVRIKTtcbiAgICAgICAgbXNnLmFwcGVuZE9iamVjdChYQ09ERV9WRVJTSU9OKTtcbiAgICAgICAgYXdhaXQgdGhpcy5fZXhlY1Rlc3RQbGFuU2Vzc2lvbi5jYWxsQ2hhbm5lbChEQUVNT05fQ09OTkVDVElPTl9JTlRFUkZBQ0UsXG4gICAgICAgICAgICAnX0lERV9pbml0aWF0ZVNlc3Npb25XaXRoSWRlbnRpZmllcjpmb3JDbGllbnQ6YXRQYXRoOnByb3RvY29sVmVyc2lvbjonLCBtc2cpO1xuICAgIH1cblxuICAgIGFzeW5jIF9ub3RpZnlUZXN0UHJvY2Vzc0lkKHBpZCwgbWFqb3JWZXJzaW9uKSB7XG4gICAgICAgIGNvbnN0IG1zZyA9IG5ldyBEVFhNZXNzYWdlQXV4QnVmZmVyKCk7XG4gICAgICAgIG1zZy5hcHBlbmRPYmplY3QocGlkKTtcbiAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA+PSBNQUpPUl9JT1NfVkVSU0lPTl8xMikge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuX2luaXRpYWxDb250cm9sU2Vzc2lvbi5jYWxsQ2hhbm5lbChEQUVNT05fQ09OTkVDVElPTl9JTlRFUkZBQ0UsXG4gICAgICAgICAgICAgICAgJ19JREVfYXV0aG9yaXplVGVzdFNlc3Npb25XaXRoUHJvY2Vzc0lEOicsIG1zZyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG1ham9yVmVyc2lvbiA8PSBNQUpPUl9JT1NfVkVSU0lPTl85KSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uLmNhbGxDaGFubmVsKERBRU1PTl9DT05ORUNUSU9OX0lOVEVSRkFDRSxcbiAgICAgICAgICAgICAgICAnX0lERV9pbml0aWF0ZUNvbnRyb2xTZXNzaW9uRm9yVGVzdFByb2Nlc3NJRDonLCBtc2cpO1xuICAgICAgICB9XG4gICAgICAgIG1zZy5hcHBlbmRPYmplY3QoWENPREVfVkVSU0lPTik7XG4gICAgICAgIHJldHVybiBhd2FpdCB0aGlzLl9pbml0aWFsQ29udHJvbFNlc3Npb24uY2FsbENoYW5uZWwoREFFTU9OX0NPTk5FQ1RJT05fSU5URVJGQUNFLFxuICAgICAgICAgICAgJ19JREVfaW5pdGlhdGVDb250cm9sU2Vzc2lvbkZvclRlc3RQcm9jZXNzSUQ6cHJvdG9jb2xWZXJzaW9uOicsIG1zZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RhcnQgeGN0ZXN0IHByb2Nlc3MuIElmIHRoaXMgbWV0aG9kIGhhcyBiZWVuIGNhbGxlZCBiZWZvcmUgYW5kIHRoZSBgc3RvcCgpYCBtZXRob2QgaGFzIG5vdCBiZWVuIGNhbGxlZCxcbiAgICAgKiBjYWxsaW5nIHRoaXMgYWdhaW4gd291bGQgcmV0dXJuIGRpcmVjdGx5LlxuICAgICAqIEB0aHJvd3MgSWYgeGN0ZXN0IGJ1bmRsZSBpZCBpbnZhbGlkIG9yIG5vdCBpbnN0YWxsZWQuXG4gICAgICovXG4gICAgYXN5bmMgc3RhcnQoKSB7XG4gICAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgICAgIGNvbnN0IHRhcmdldE1lc3NhZ2UgPSB0aGlzLnRhcmdldEJ1bmRsZUlkID8gYCh0YXJnZXRpbmcgJHt0aGlzLnRhcmdldEJ1bmRsZUlkfSlgIDogJyc7XG4gICAgICAgICAgICBjb25zdCBtZXNzYWdlID0gYFhjdGVzdCBmb3IgJHt0aGlzLnhjdGVzdEJ1bmRsZUlkfSR7dGFyZ2V0TWVzc2FnZX0gb24gZGV2aWNlICR7dGhpcy51ZGlkfSBpcyBhbHJlYWR5IHJ1bm5pbmchYDtcbiAgICAgICAgICAgIGxvZy5pbmZvKGAke21lc3NhZ2V9IERvaW5nIG5vdGhpbmcgaGVyZWApO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucnVubmluZyA9IHRydWU7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBwcm9kdWN0VmVyc2lvbiA9IGF3YWl0IGdldE9TVmVyc2lvbih0aGlzLnVkaWQpO1xuICAgICAgICAgICAgY29uc3QgbWFqb3JWZXJzaW9uID0gcGFyc2VJbnQocHJvZHVjdFZlcnNpb24uc3BsaXQoJy4nKVswXSwgMTApO1xuICAgICAgICAgICAgY29uc3Qgc2Vzc2lvbklkZW50aWZpZXIgPSB1dGlsLnV1aWRWNCgpO1xuICAgICAgICAgICAgLy9maXJzdCBjb25uZWN0aW9uXG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9zdGFydEluaXRpYWxTZXNzaW9uKG1ham9yVmVyc2lvbik7XG5cbiAgICAgICAgICAgIC8vc2Vjb25kIGNvbm5lY3Rpb25cbiAgICAgICAgICAgIGF3YWl0IHRoaXMuX3N0YXJ0RXhlY1Nlc3Npb24oc2Vzc2lvbklkZW50aWZpZXIpO1xuXG4gICAgICAgICAgICBjb25zdCBwaWQgPSBhd2FpdCB0aGlzLl9sYXVuY2hBcHBSdW5uZXIobWFqb3JWZXJzaW9uLCBzZXNzaW9uSWRlbnRpZmllcik7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLl9ub3RpZnlUZXN0UHJvY2Vzc0lkKHBpZCwgbWFqb3JWZXJzaW9uKTtcbiAgICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcCB4Y3Rlc3QgcHJvY2Vzcy5cbiAgICAgKi9cbiAgICBzdG9wKCkge1xuICAgICAgICBpZiAoIXRoaXMucnVubmluZykge1xuICAgICAgICAgICAgLy8gbm90IHN0YXJ0ZWQgb3IgYWxyZWFkeSBjYWxsZWQgYHN0b3AoKWBcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJ1bm5pbmcgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5faW5zdHJ1bWVudFNlcnZpY2U/LmNsb3NlKCk7XG4gICAgICAgIHRoaXMuX2luc3RydW1lbnRTZXJ2aWNlPy5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuX2luc3RydW1lbnRTZXJ2aWNlID0gdW5kZWZpbmVkO1xuICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uPy5jbG9zZSgpO1xuICAgICAgICB0aGlzLl9leGVjVGVzdFBsYW5TZXNzaW9uPy5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuX2V4ZWNUZXN0UGxhblNlc3Npb24gPSB1bmRlZmluZWQ7XG4gICAgICAgIHRoaXMuX2luaXRpYWxDb250cm9sU2Vzc2lvbj8uY2xvc2UoKTtcbiAgICAgICAgdGhpcy5faW5pdGlhbENvbnRyb2xTZXNzaW9uPy5kaXNwb3NlKCk7XG4gICAgICAgIHRoaXMuX2luaXRpYWxDb250cm9sU2Vzc2lvbiA9IHVuZGVmaW5lZDtcbiAgICAgICAgdGhpcy5fZXhlY3V0aW5nID0gZmFsc2U7XG4gICAgICAgIGNvbnN0IHRhcmdldE1lc3NhZ2UgPSB0aGlzLnRhcmdldEJ1bmRsZUlkID8gYCh0YXJnZXRpbmcgJHt0aGlzLnRhcmdldEJ1bmRsZUlkfSlgIDogJyc7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2UgPSBgWGN0ZXN0IGZvciAke3RoaXMueGN0ZXN0QnVuZGxlSWR9JHt0YXJnZXRNZXNzYWdlfSBvbiBkZXZpY2UgJHt0aGlzLnVkaWR9IGhhcyBzdG9wcGVkIWA7XG4gICAgICAgIGxvZy5kZWJ1ZyhtZXNzYWdlKTtcbiAgICB9XG59XG5cbmV4cG9ydCB7IFhjdGVzdCB9O1xuZXhwb3J0IGRlZmF1bHQgWGN0ZXN0O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLFNBQUEsR0FBQUMsT0FBQTtBQUNBLElBQUFDLFdBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLFFBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLFFBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLGFBQUEsR0FBQUosT0FBQTtBQUNBLElBQUFLLFFBQUEsR0FBQUwsT0FBQTtBQUNBLElBQUFNLFVBQUEsR0FBQU4sT0FBQTtBQUNBLElBQUFPLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQVIsT0FBQTtBQUNBLElBQUFTLFNBQUEsR0FBQUQsc0JBQUEsQ0FBQVIsT0FBQTtBQUVBLE1BQU07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