"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.findDeveloperImage = findDeveloperImage;
require("source-map-support/register");
var _lodash = _interopRequireDefault(require("lodash"));
var _support = require("@appium/support");
var _path = require("path");
var _axios = _interopRequireDefault(require("axios"));
var _logger = _interopRequireDefault(require("../../logger"));
const {
  exists,
  readdir,
  mkdir,
  rimraf
} = _support.fs;
const DEFAULT_IMAGE_DIR_NAME = 'iOSDeviceSupport';
const DEVELOPER_IMAGE_FILE_NAME = 'DeveloperDiskImage.dmg';
const DEVELOPER_IMAGE_SIGNATURE_FILE_NAME = 'DeveloperDiskImage.dmg.signature';
async function listGithubImageList(githubImageOption) {
  const {
    githubRepo,
    subFolderList = [],
    branch = 'master'
  } = githubImageOption;
  const initialUrl = `https://api.github.com/repos/${githubRepo}/git/trees/${branch}`;
  const repoUrl = `https://github.com/${githubRepo}/`;
  const fileList = [];
  let curUrl = initialUrl;
  for (let i = 0; i <= subFolderList.length; i++) {
    const res = await _axios.default.get(curUrl);
    const body = res.data;
    const treeList = body === null || body === void 0 ? void 0 : body.tree;
    if (!treeList) {
      throw new Error(`Failed on looking up ${fileList.join('/')} under ${repoUrl}: ${JSON.stringify(body)}`);
    }
    if (i === subFolderList.length) {
      return treeList;
    }
    const entry = subFolderList[i];
    const nextItem = _lodash.default.find(treeList, item => item.path === entry);
    if (!nextItem) {
      const errMsg = `Unable to find ${entry} under ${fileList.join('/')} in ${repoUrl}`;
      throw new Error(`${errMsg}: ${JSON.stringify(treeList)}`);
    }
    if (nextItem.type !== 'tree') {
      const errMsg = `${entry} under ${fileList.join('/')} in ${repoUrl} is expected to be a tree`;
      throw new Error(`${errMsg}, got ${nextItem.type} instead.`);
    }
    fileList.push(entry);
    curUrl = nextItem.url;
  }
}
async function findDeveloperImageFromDirectory(entry) {
  const fileList = await readdir(entry, {
    withFileTypes: true
  });
  for (const subEntry of fileList) {
    if (subEntry.name === DEVELOPER_IMAGE_FILE_NAME && subEntry.isFile()) {
      return entry;
    }
    if (subEntry.isDirectory()) {
      const fullPath = (0, _path.join)(entry, subEntry.name);
      const subFolderResult = await findDeveloperImageFromDirectory(fullPath);
      if (subFolderResult) {
        return subFolderResult;
      }
    }
  }
}
async function findDeveloperImage(version, githubImageOption) {
  const finalVersion = version.split('.').splice(0, 2).join('.');
  const fileName = `${finalVersion}.zip`;
  const DEFAULT_IMAGE_DIR = (0, _path.join)(await _support.env.resolveAppiumHome(), DEFAULT_IMAGE_DIR_NAME);
  const fullDownloadPath = (0, _path.join)(DEFAULT_IMAGE_DIR, fileName);
  if (!(await exists(DEFAULT_IMAGE_DIR))) {
    await mkdir(DEFAULT_IMAGE_DIR, {
      recursive: true
    });
  }
  if (!(await exists(fullDownloadPath))) {
    await searchAndDownloadDeveloperImageFromGithub(finalVersion, fullDownloadPath, githubImageOption);
  }
  const decompressPath = (0, _path.join)(DEFAULT_IMAGE_DIR, finalVersion);
  let developerImageParentFolder;
  if (await exists(decompressPath)) {
    developerImageParentFolder = await findDeveloperImageFromDirectory(decompressPath);
  }
  if (!developerImageParentFolder) {
    await _support.zip.extractAllTo(fullDownloadPath, decompressPath);
    developerImageParentFolder = await findDeveloperImageFromDirectory(decompressPath);
  }
  if (!developerImageParentFolder) {
    throw new Error(`Unable to find unzipped developer image in ${decompressPath}`);
  }
  return {
    developerImage: (0, _path.join)(developerImageParentFolder, DEVELOPER_IMAGE_FILE_NAME),
    developerImageSignature: (0, _path.join)(developerImageParentFolder, DEVELOPER_IMAGE_SIGNATURE_FILE_NAME)
  };
}
async function searchAndDownloadDeveloperImageFromGithub(finalVersion, fullDownloadPath, githubImageOption) {
  const fileNameRegExp = new RegExp(`${_lodash.default.escapeRegExp(finalVersion)}(\\(([\\w_|.()])+\\))?.zip`);
  const {
    githubRepo,
    subFolderList = [],
    branch = 'master'
  } = githubImageOption;
  let fileUrl;
  const fileList = await listGithubImageList(githubImageOption);
  if (!fileList) {
    throw new Error(`Failed to list https://github.com/${githubRepo}`);
    ;
  }
  const targetFile = _lodash.default.find(fileList, item => fileNameRegExp.test(item.path));
  const splitter = subFolderList.length > 0 ? '/' : '';
  const subFolderPath = `${splitter}${subFolderList.join('/')}${splitter}`;
  if (targetFile) {
    fileUrl = `https://raw.githubusercontent.com/${githubRepo}/${branch}${subFolderPath}${targetFile.path}`;
  }
  if (!fileUrl) {
    throw new Error(`Failed to get developer image for iOS ${finalVersion}`);
  }
  try {
    _logger.default.info(`Downloading developer image for ${finalVersion} to ${fullDownloadPath} from ${fileUrl}`);
    await _support.net.downloadFile(fileUrl, fullDownloadPath);
  } catch (e) {
    await rimraf(fullDownloadPath);
    throw e;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfbG9kYXNoIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsInJlcXVpcmUiLCJfc3VwcG9ydCIsIl9wYXRoIiwiX2F4aW9zIiwiX2xvZ2dlciIsImV4aXN0cyIsInJlYWRkaXIiLCJta2RpciIsInJpbXJhZiIsImZzIiwiREVGQVVMVF9JTUFHRV9ESVJfTkFNRSIsIkRFVkVMT1BFUl9JTUFHRV9GSUxFX05BTUUiLCJERVZFTE9QRVJfSU1BR0VfU0lHTkFUVVJFX0ZJTEVfTkFNRSIsImxpc3RHaXRodWJJbWFnZUxpc3QiLCJnaXRodWJJbWFnZU9wdGlvbiIsImdpdGh1YlJlcG8iLCJzdWJGb2xkZXJMaXN0IiwiYnJhbmNoIiwiaW5pdGlhbFVybCIsInJlcG9VcmwiLCJmaWxlTGlzdCIsImN1clVybCIsImkiLCJsZW5ndGgiLCJyZXMiLCJheGlvcyIsImdldCIsImJvZHkiLCJkYXRhIiwidHJlZUxpc3QiLCJ0cmVlIiwiRXJyb3IiLCJqb2luIiwiSlNPTiIsInN0cmluZ2lmeSIsImVudHJ5IiwibmV4dEl0ZW0iLCJfIiwiZmluZCIsIml0ZW0iLCJwYXRoIiwiZXJyTXNnIiwidHlwZSIsInB1c2giLCJ1cmwiLCJmaW5kRGV2ZWxvcGVySW1hZ2VGcm9tRGlyZWN0b3J5Iiwid2l0aEZpbGVUeXBlcyIsInN1YkVudHJ5IiwibmFtZSIsImlzRmlsZSIsImlzRGlyZWN0b3J5IiwiZnVsbFBhdGgiLCJqb2luUGF0aCIsInN1YkZvbGRlclJlc3VsdCIsImZpbmREZXZlbG9wZXJJbWFnZSIsInZlcnNpb24iLCJmaW5hbFZlcnNpb24iLCJzcGxpdCIsInNwbGljZSIsImZpbGVOYW1lIiwiREVGQVVMVF9JTUFHRV9ESVIiLCJlbnYiLCJyZXNvbHZlQXBwaXVtSG9tZSIsImZ1bGxEb3dubG9hZFBhdGgiLCJyZWN1cnNpdmUiLCJzZWFyY2hBbmREb3dubG9hZERldmVsb3BlckltYWdlRnJvbUdpdGh1YiIsImRlY29tcHJlc3NQYXRoIiwiZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXIiLCJ6aXAiLCJleHRyYWN0QWxsVG8iLCJkZXZlbG9wZXJJbWFnZSIsImRldmVsb3BlckltYWdlU2lnbmF0dXJlIiwiZmlsZU5hbWVSZWdFeHAiLCJSZWdFeHAiLCJlc2NhcGVSZWdFeHAiLCJmaWxlVXJsIiwidGFyZ2V0RmlsZSIsInRlc3QiLCJzcGxpdHRlciIsInN1YkZvbGRlclBhdGgiLCJsb2ciLCJpbmZvIiwibmV0IiwiZG93bmxvYWRGaWxlIiwiZSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL2xpYi9pbWFnZW1vdW50ZXIvdXRpbHMvbGlzdF9kZXZlbG9wZXJfaW1hZ2UuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHppcCwgbmV0LCBlbnYsIGZzIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCB7IGpvaW4gYXMgam9pblBhdGggfSBmcm9tICdwYXRoJztcbmltcG9ydCBheGlvcyBmcm9tICdheGlvcyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uLy4uL2xvZ2dlcic7XG5cbmNvbnN0IHsgZXhpc3RzLCByZWFkZGlyLCBta2RpciwgcmltcmFmIH0gPSBmcztcbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gR2l0aHViVHJlZU9iamVjdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBhdGhcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBtb2RlXG4gKiBAcHJvcGVydHkgeydibG9iJyB8ICd0cmVlJ30gdHlwZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHNoYVxuICogQHByb3BlcnR5IHtudW1iZXJ9IHNpemVcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmxcbiAqL1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEdpdGh1YlRyZWVSZXNwb25zZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHNoYVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHVybFxuICogQHByb3BlcnR5IHtHaXRodWJUcmVlT2JqZWN0W119IFt0cmVlXVxuICogQHByb3BlcnR5IHtib29sZWFufSBbdHJ1bmNhdGVkXVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtub2RlX2lkXVxuICogQHByb3BlcnR5IHtudW1iZXJ9IFtzaXplXVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtjb250ZW50XVxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtiYXNlNjRdXG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBJbWFnZUZyb21HaXRodWJSZXBvIE9wdGlvbiB0byBpbmRpY2F0ZSB3aGljaCBnaXRodWIgcmVwbyBhbmQgc3ViZm9sZGVyIHRvIHVzZSB0byBzZWFyY2ggZGV2ZWxvcGVyXG4gKiBpbWFnZS4gVGhlIGltYWdlIGFuZCBzaWduYXR1cmUgZmlsZXMgc2hvdWxkIGJlIGNvbXByZXNzZWQgaW50byBhIHppcCBmb3JtYXQsIGFuZCB0aGUgZmlsZW5hbWUgc2hvdWxkIG1hdGNoIHRoaXNcbiAqIHJlZ3VsYXIgZXhwcmVzc2lvbjogYCR7ZmluYWxWZXJzaW9ufShcXFxcKChbXFxcXHdffC4oKV0pK1xcXFwpKT8uemlwYFxuICogQHByb3BlcnR5IHtzdHJpbmd9IGdpdGh1YlJlcG8gVGhpcyBzaG91bGQgYmUgaW4gZm9ybWF0IG9mIGAkKGdyb3VwIG9yIHVzZXJuYW1lKS8ke3JlcG9zaXRvcnl9YCwgd2hpY2ggY29udGFpbnNcbiAqIGF2YWlsYWJsZSBpbWFnZXMuXG4gKiBAcHJvcGVydHkge3N0cmluZ30gYnJhbmNoXG4gKiBAcHJvcGVydHkge3N0cmluZ1tdfSBbc3ViRm9sZGVyTGlzdF0gc3ViZm9sZGVyIGxpc3QgaW4gbGV2ZWwgb3JkZXJcbiAqL1xuY29uc3QgREVGQVVMVF9JTUFHRV9ESVJfTkFNRSA9ICdpT1NEZXZpY2VTdXBwb3J0JztcbmNvbnN0IERFVkVMT1BFUl9JTUFHRV9GSUxFX05BTUUgPSAnRGV2ZWxvcGVyRGlza0ltYWdlLmRtZyc7XG5jb25zdCBERVZFTE9QRVJfSU1BR0VfU0lHTkFUVVJFX0ZJTEVfTkFNRSA9ICdEZXZlbG9wZXJEaXNrSW1hZ2UuZG1nLnNpZ25hdHVyZSc7XG5cbi8qKlxuICogVXNlIGxpc3QgYXBpIHRvIHJldHVybiB0aGUgZmlsZSBsaXN0IG9mIGZvbGRlci5cbiAqIEBwYXJhbSB7SW1hZ2VGcm9tR2l0aHViUmVwb30gZ2l0aHViSW1hZ2VPcHRpb25cbiAqIEByZXR1cm5zIHtQcm9taXNlPEdpdGh1YlRyZWVPYmplY3RbXSB8IHVuZGVmaW5lZD59IGZpbGUgbGlzdCB1bmRlciB0YXJnZXQgZm9sZGVyXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGxpc3RHaXRodWJJbWFnZUxpc3QoZ2l0aHViSW1hZ2VPcHRpb24pIHtcbiAgICBjb25zdCB7IGdpdGh1YlJlcG8sIHN1YkZvbGRlckxpc3QgPSBbXSwgYnJhbmNoID0gJ21hc3RlcicgfSA9IGdpdGh1YkltYWdlT3B0aW9uO1xuICAgIGNvbnN0IGluaXRpYWxVcmwgPSBgaHR0cHM6Ly9hcGkuZ2l0aHViLmNvbS9yZXBvcy8ke2dpdGh1YlJlcG99L2dpdC90cmVlcy8ke2JyYW5jaH1gO1xuICAgIGNvbnN0IHJlcG9VcmwgPSBgaHR0cHM6Ly9naXRodWIuY29tLyR7Z2l0aHViUmVwb30vYDtcbiAgICBjb25zdCBmaWxlTGlzdCA9IFtdO1xuICAgIGxldCBjdXJVcmwgPSBpbml0aWFsVXJsO1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtHaXRodWJUcmVlT2JqZWN0W10gfCB1bmRlZmluZWR9XG4gICAgICovXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPD0gc3ViRm9sZGVyTGlzdC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBheGlvcy5nZXQoY3VyVXJsKTtcbiAgICAgICAgLyoqXG4gICAgICAgICAqIEB0eXBlIHtHaXRodWJUcmVlUmVzcG9uc2V9XG4gICAgICAgICAqL1xuICAgICAgICBjb25zdCBib2R5ID0gcmVzLmRhdGE7XG4gICAgICAgIGNvbnN0IHRyZWVMaXN0ID0gYm9keT8udHJlZTtcbiAgICAgICAgaWYgKCF0cmVlTGlzdCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgb24gbG9va2luZyB1cCAke2ZpbGVMaXN0LmpvaW4oJy8nKX0gdW5kZXIgJHtyZXBvVXJsfTogJHtKU09OLnN0cmluZ2lmeShib2R5KX1gKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaSA9PT0gc3ViRm9sZGVyTGlzdC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiB0cmVlTGlzdDtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBlbnRyeSA9IHN1YkZvbGRlckxpc3RbaV07XG4gICAgICAgIGNvbnN0IG5leHRJdGVtID0gXy5maW5kKHRyZWVMaXN0LCAoaXRlbSkgPT4gaXRlbS5wYXRoID09PSBlbnRyeSk7XG4gICAgICAgIGlmICghbmV4dEl0ZW0pIHtcbiAgICAgICAgICAgIGNvbnN0IGVyck1zZyA9IGBVbmFibGUgdG8gZmluZCAke2VudHJ5fSB1bmRlciAke2ZpbGVMaXN0LmpvaW4oJy8nKX0gaW4gJHtyZXBvVXJsfWA7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZXJyTXNnfTogJHtKU09OLnN0cmluZ2lmeSh0cmVlTGlzdCl9YCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG5leHRJdGVtLnR5cGUgIT09ICd0cmVlJykge1xuICAgICAgICAgICAgY29uc3QgZXJyTXNnID0gYCR7ZW50cnl9IHVuZGVyICR7ZmlsZUxpc3Quam9pbignLycpfSBpbiAke3JlcG9Vcmx9IGlzIGV4cGVjdGVkIHRvIGJlIGEgdHJlZWA7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7ZXJyTXNnfSwgZ290ICR7bmV4dEl0ZW0udHlwZX0gaW5zdGVhZC5gKTtcbiAgICAgICAgfVxuICAgICAgICBmaWxlTGlzdC5wdXNoKGVudHJ5KTtcbiAgICAgICAgY3VyVXJsID0gbmV4dEl0ZW0udXJsO1xuICAgIH1cbn1cblxuLyoqXG4gKiBGaW5kIGBEZXZlbG9wZXJEaXNrSW1hZ2UuZG1nYCByZWN1cnNpdmVseSB1bmRlciBmb2xkZXIgYW5kIHN1YmZvbGRlci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBlbnRyeSBjdXJyZW50IGZvbGRlclxuICogQHJldHVybnMge1Byb21pc2U8c3RyaW5nIHwgdW5kZWZpbmVkPn0gcGFyZW50IGZvbGRlciBvZiBgRGV2ZWxvcGVyRGlza0ltYWdlLmRtZ2AsXG4gKiAgb3IgYHVuZGVmaW5lZGAgaWYgbm8gc3VjaCBmaWxlIGV4aXN0c1xuICovXG5hc3luYyBmdW5jdGlvbiBmaW5kRGV2ZWxvcGVySW1hZ2VGcm9tRGlyZWN0b3J5KGVudHJ5KSB7XG4gICAgY29uc3QgZmlsZUxpc3QgPSBhd2FpdCByZWFkZGlyKGVudHJ5LCB7IHdpdGhGaWxlVHlwZXM6IHRydWUgfSk7XG4gICAgZm9yIChjb25zdCBzdWJFbnRyeSBvZiBmaWxlTGlzdCkge1xuICAgICAgICBpZiAoc3ViRW50cnkubmFtZSA9PT0gREVWRUxPUEVSX0lNQUdFX0ZJTEVfTkFNRSAmJiBzdWJFbnRyeS5pc0ZpbGUoKSkge1xuICAgICAgICAgICAgcmV0dXJuIGVudHJ5O1xuICAgICAgICB9XG4gICAgICAgIGlmIChzdWJFbnRyeS5pc0RpcmVjdG9yeSgpKSB7XG4gICAgICAgICAgICBjb25zdCBmdWxsUGF0aCA9IGpvaW5QYXRoKGVudHJ5LCBzdWJFbnRyeS5uYW1lKTtcbiAgICAgICAgICAgIGNvbnN0IHN1YkZvbGRlclJlc3VsdCA9IGF3YWl0IGZpbmREZXZlbG9wZXJJbWFnZUZyb21EaXJlY3RvcnkoZnVsbFBhdGgpO1xuICAgICAgICAgICAgaWYgKHN1YkZvbGRlclJlc3VsdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzdWJGb2xkZXJSZXN1bHQ7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG59XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW1hZ2VQYXRoXG4gKiBAcHJvcGVydHkge3N0cmluZ30gZGV2ZWxvcGVySW1hZ2VcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBkZXZlbG9wZXJJbWFnZVNpZ25hdHVyZVxuICovXG5cbi8qKlxuICogRmluZCBkZXZlbG9wZXIgaW1hZ2UgZm9yIGNlcnRhaW4gdmVyc2lvbi4gSWYgZGV2ZWxvcGVyIGltYWdlIGRvZXMgbm90IGV4aXN0cyxcbiAqIHRoaXMgd2lsbCB0cnkgdG8gZmluZCBhbmQgZG93bmxvYWQgZGV2ZWxvcGVyIGltYWdlLCB1bnppcCB0byBgJHtBUFBJVU1fSE9NRX0vaU9TU3VwcG9ydC9gXG4gKiBAcGFyYW0ge3N0cmluZ30gdmVyc2lvbiBmdWxsIHZlcnNpb24gb2YgaU9TIGRldmljZS4gVGhlIGZpcnN0IHR3byBwYXJ0cyBvZiB2ZXJzaW9uXG4gKiB3aWxsIGJlIHByZXNlcnZlZCB3aGVuIHNlbmRpbmcgdGhlIHJlcXVlc3QsIGUuZy4gYDE0LjcuMWAgd2lsbCBiZSBjaGFuZ2VkIHRvIGAxNC43YFxuICogQHBhcmFtIHtJbWFnZUZyb21HaXRodWJSZXBvfSBnaXRodWJJbWFnZU9wdGlvblxuICogQHJldHVybnMge1Byb21pc2U8SW1hZ2VQYXRoPn1cbiAqIEB0aHJvd3MgSWYgZGV2ZWxvcGVyIGltYWdlIGlzIG5vdCBmb3VuZCwgb3IgZXJyb3Igd2hpbGUgZG93bmxvYWRpbmcgb3IgdW56aXBwaW5nLlxuICovXG5hc3luYyBmdW5jdGlvbiBmaW5kRGV2ZWxvcGVySW1hZ2UodmVyc2lvbiwgZ2l0aHViSW1hZ2VPcHRpb24pIHtcbiAgICBjb25zdCBmaW5hbFZlcnNpb24gPSB2ZXJzaW9uLnNwbGl0KCcuJykuc3BsaWNlKDAsIDIpLmpvaW4oJy4nKTtcbiAgICBjb25zdCBmaWxlTmFtZSA9IGAke2ZpbmFsVmVyc2lvbn0uemlwYDtcbiAgICBjb25zdCBERUZBVUxUX0lNQUdFX0RJUiA9IGpvaW5QYXRoKGF3YWl0IGVudi5yZXNvbHZlQXBwaXVtSG9tZSgpLCBERUZBVUxUX0lNQUdFX0RJUl9OQU1FKTtcbiAgICBjb25zdCBmdWxsRG93bmxvYWRQYXRoID0gam9pblBhdGgoREVGQVVMVF9JTUFHRV9ESVIsIGZpbGVOYW1lKTtcbiAgICBpZiAoIWF3YWl0IGV4aXN0cyhERUZBVUxUX0lNQUdFX0RJUikpIHtcbiAgICAgICAgYXdhaXQgbWtkaXIoREVGQVVMVF9JTUFHRV9ESVIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGV4aXN0cyhmdWxsRG93bmxvYWRQYXRoKSkge1xuICAgICAgICBhd2FpdCBzZWFyY2hBbmREb3dubG9hZERldmVsb3BlckltYWdlRnJvbUdpdGh1YihmaW5hbFZlcnNpb24sIGZ1bGxEb3dubG9hZFBhdGgsIGdpdGh1YkltYWdlT3B0aW9uKTtcbiAgICB9XG4gICAgY29uc3QgZGVjb21wcmVzc1BhdGggPSBqb2luUGF0aChERUZBVUxUX0lNQUdFX0RJUiwgZmluYWxWZXJzaW9uKTtcbiAgICAvKiogQHR5cGUge3N0cmluZyB8IHVuZGVmaW5lZH0gKi9cbiAgICBsZXQgZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXI7XG4gICAgaWYgKGF3YWl0IGV4aXN0cyhkZWNvbXByZXNzUGF0aCkpIHtcbiAgICAgICAgZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXIgPSBhd2FpdCBmaW5kRGV2ZWxvcGVySW1hZ2VGcm9tRGlyZWN0b3J5KGRlY29tcHJlc3NQYXRoKTtcbiAgICB9XG4gICAgaWYgKCFkZXZlbG9wZXJJbWFnZVBhcmVudEZvbGRlcikge1xuICAgICAgICBhd2FpdCB6aXAuZXh0cmFjdEFsbFRvKGZ1bGxEb3dubG9hZFBhdGgsIGRlY29tcHJlc3NQYXRoKTtcbiAgICAgICAgZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXIgPSBhd2FpdCBmaW5kRGV2ZWxvcGVySW1hZ2VGcm9tRGlyZWN0b3J5KGRlY29tcHJlc3NQYXRoKTtcbiAgICB9XG4gICAgaWYgKCFkZXZlbG9wZXJJbWFnZVBhcmVudEZvbGRlcikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBmaW5kIHVuemlwcGVkIGRldmVsb3BlciBpbWFnZSBpbiAke2RlY29tcHJlc3NQYXRofWApO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBkZXZlbG9wZXJJbWFnZTogam9pblBhdGgoZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXIsIERFVkVMT1BFUl9JTUFHRV9GSUxFX05BTUUpLFxuICAgICAgICBkZXZlbG9wZXJJbWFnZVNpZ25hdHVyZTogam9pblBhdGgoZGV2ZWxvcGVySW1hZ2VQYXJlbnRGb2xkZXIsIERFVkVMT1BFUl9JTUFHRV9TSUdOQVRVUkVfRklMRV9OQU1FKVxuICAgIH07XG59XG5cbi8qKlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBmaW5hbFZlcnNpb25cbiAqIEBwYXJhbSB7c3RyaW5nfSBmdWxsRG93bmxvYWRQYXRoXG4gKiBAcGFyYW0ge0ltYWdlRnJvbUdpdGh1YlJlcG99IGdpdGh1YkltYWdlT3B0aW9uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNlYXJjaEFuZERvd25sb2FkRGV2ZWxvcGVySW1hZ2VGcm9tR2l0aHViKGZpbmFsVmVyc2lvbiwgZnVsbERvd25sb2FkUGF0aCwgZ2l0aHViSW1hZ2VPcHRpb24pIHtcbiAgICBjb25zdCBmaWxlTmFtZVJlZ0V4cCA9IG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAoZmluYWxWZXJzaW9uKX0oXFxcXCgoW1xcXFx3X3wuKCldKStcXFxcKSk/LnppcGApO1xuICAgIGNvbnN0IHsgZ2l0aHViUmVwbywgc3ViRm9sZGVyTGlzdCA9IFtdLCBicmFuY2ggPSAnbWFzdGVyJyB9ID0gZ2l0aHViSW1hZ2VPcHRpb247XG4gICAgLyoqIEB0eXBlIHtzdHJpbmcgfCB1bmRlZmluZWR9ICovXG4gICAgbGV0IGZpbGVVcmw7XG4gICAgY29uc3QgZmlsZUxpc3QgPSBhd2FpdCBsaXN0R2l0aHViSW1hZ2VMaXN0KGdpdGh1YkltYWdlT3B0aW9uKTtcbiAgICBpZiAoIWZpbGVMaXN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIGxpc3QgaHR0cHM6Ly9naXRodWIuY29tLyR7Z2l0aHViUmVwb31gKTs7XG4gICAgfVxuICAgIGNvbnN0IHRhcmdldEZpbGUgPSBfLmZpbmQoZmlsZUxpc3QsIChpdGVtKSA9PiBmaWxlTmFtZVJlZ0V4cC50ZXN0KGl0ZW0ucGF0aCkpO1xuICAgIGNvbnN0IHNwbGl0dGVyID0gc3ViRm9sZGVyTGlzdC5sZW5ndGggPiAwID8gJy8nIDogJyc7XG4gICAgY29uc3Qgc3ViRm9sZGVyUGF0aCA9IGAke3NwbGl0dGVyfSR7c3ViRm9sZGVyTGlzdC5qb2luKCcvJyl9JHtzcGxpdHRlcn1gO1xuICAgIGlmICh0YXJnZXRGaWxlKSB7XG4gICAgICAgIGZpbGVVcmwgPSBgaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tLyR7Z2l0aHViUmVwb30vJHticmFuY2h9JHtzdWJGb2xkZXJQYXRofSR7dGFyZ2V0RmlsZS5wYXRofWA7XG4gICAgfVxuICAgIGlmICghZmlsZVVybCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBnZXQgZGV2ZWxvcGVyIGltYWdlIGZvciBpT1MgJHtmaW5hbFZlcnNpb259YCk7XG4gICAgfVxuICAgIHRyeSB7XG4gICAgICAgIGxvZy5pbmZvKGBEb3dubG9hZGluZyBkZXZlbG9wZXIgaW1hZ2UgZm9yICR7ZmluYWxWZXJzaW9ufSB0byAke2Z1bGxEb3dubG9hZFBhdGh9IGZyb20gJHtmaWxlVXJsfWApO1xuICAgICAgICBhd2FpdCBuZXQuZG93bmxvYWRGaWxlKGZpbGVVcmwsIGZ1bGxEb3dubG9hZFBhdGgpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgYXdhaXQgcmltcmFmKGZ1bGxEb3dubG9hZFBhdGgpO1xuICAgICAgICB0aHJvdyBlO1xuICAgIH1cbn1cblxuZXhwb3J0IHsgZmluZERldmVsb3BlckltYWdlIH07Il0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLElBQUFBLE9BQUEsR0FBQUMsc0JBQUEsQ0FBQUMsT0FBQTtBQUNBLElBQUFDLFFBQUEsR0FBQUQsT0FBQTtBQUNBLElBQUFFLEtBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLE1BQUEsR0FBQUos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