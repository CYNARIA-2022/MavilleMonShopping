"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startAfcService = startAfcService;
exports.startCrashLogService = startCrashLogService;
exports.startHouseArrestService = startHouseArrestService;
exports.startImageMounterService = startImageMounterService;
exports.startInstallationProxyService = startInstallationProxyService;
exports.startInstrumentService = startInstrumentService;
exports.startMCInstallService = startMCInstallService;
exports.startNotificationProxyService = startNotificationProxyService;
exports.startSimulateLocationService = startSimulateLocationService;
exports.startSyslogService = startSyslogService;
exports.startTestmanagerdService = startTestmanagerdService;
exports.startWebInspectorService = startWebInspectorService;
require("source-map-support/register");
var _utilities = require("./utilities");
var _syslog = require("./syslog");
var _simulatelocation = require("./simulatelocation");
var _webinspector = require("./webinspector");
var _installationProxy = require("./installation-proxy");
var _afc = require("./afc");
var _notificationProxy = require("./notification-proxy");
var _houseArrest = require("./house-arrest");
var _instrument = require("./instrument");
var _testmanagerd = require("./testmanagerd");
var _mcinstall = require("./mcinstall");
var _imagemounter = require("./imagemounter");
var _plistService = _interopRequireDefault(require("./plist-service"));
var _semver = _interopRequireDefault(require("semver"));
const CRASH_LOG_SERVICE_NAME = 'com.apple.crashreportcopymobile';
const INSTRUMENT_HANDSHAKE_VERSION = 14;
const TESTMANAGERD_HANDSHAKE_VERSION = 14;
async function startSyslogService(udid, opts = {}) {
  const socket = await startService(udid, _syslog.SYSLOG_SERVICE_NAME, opts.socket);
  return new _syslog.SyslogService(socket);
}
async function startSimulateLocationService(udid, opts = {}) {
  const socket = await startService(udid, _simulatelocation.SIMULATE_LOCATION_SERVICE_NAME, opts.socket);
  return new _simulatelocation.SimulateLocationService(socket);
}
async function startWebInspectorService(udid, opts = {}) {
  const osVersion = opts.osVersion || (await (0, _utilities.getOSVersion)(udid, opts.socket));
  const isSimulator = !!opts.isSimulator;
  const verbose = !!opts.verbose;
  const verboseHexDump = !!opts.verboseHexDump;
  const socketChunkSize = opts.socketChunkSize;
  const maxFrameLength = opts.maxFrameLength;
  const semverVersion = _semver.default.coerce(osVersion);
  if (!semverVersion) {
    throw new Error(`Could not create a semver version out of '${osVersion}'`);
  }
  if (opts.socket) {
    return new _webinspector.WebInspectorService({
      majorOsVersion: semverVersion.major,
      isSimulator,
      socketChunkSize,
      verbose,
      verboseHexDump,
      socketClient: opts.socket,
      maxFrameLength
    });
  }
  const socket = await startService(udid, _webinspector.WEB_INSPECTOR_SERVICE_NAME, undefined);
  return new _webinspector.WebInspectorService({
    majorOsVersion: semverVersion.major,
    isSimulator,
    socketChunkSize,
    verbose,
    verboseHexDump,
    socketClient: socket,
    maxFrameLength
  });
}
async function startInstallationProxyService(udid, opts = {}) {
  const socket = await startService(udid, _installationProxy.INSTALLATION_PROXY_SERVICE_NAME, opts.socket);
  return new _installationProxy.InstallationProxyService(new _plistService.default(socket));
}
async function startAfcService(udid, opts = {}) {
  const socket = await startService(udid, _afc.AFC_SERVICE_NAME, opts.socket);
  return new _afc.AfcService(socket);
}
async function startCrashLogService(udid, opts = {}) {
  const socket = await startService(udid, CRASH_LOG_SERVICE_NAME, opts.socket);
  return new _afc.AfcService(socket);
}
async function startNotificationProxyService(udid, opts = {}) {
  const socket = await startService(udid, _notificationProxy.NOTIFICATION_PROXY_SERVICE_NAME, opts.socket);
  return new _notificationProxy.NotificationProxyService(socket);
}
async function startHouseArrestService(udid, opts = {}) {
  const socket = await startService(udid, _houseArrest.HOUSE_ARREST_SERVICE_NAME, opts.socket);
  return new _houseArrest.HouseArrestService(socket);
}
async function startInstrumentService(udid, opts = {}) {
  const osVersion = opts.osVersion || (await (0, _utilities.getOSVersion)(udid, opts.socket));
  return new _instrument.InstrumentService(parseInt(osVersion.split('.')[0], 10) < INSTRUMENT_HANDSHAKE_VERSION ? await startService(udid, _instrument.INSTRUMENT_SERVICE_NAME, opts.socket, true) : await startService(udid, _instrument.INSTRUMENT_SERVICE_NAME_VERSION_14, opts.socket));
}
async function startTestmanagerdService(udid, opts = {}) {
  const osVersion = opts.osVersion || (await (0, _utilities.getOSVersion)(udid, opts.socket));
  return new _testmanagerd.TestmanagerdService(parseInt(osVersion.split('.')[0], 10) < TESTMANAGERD_HANDSHAKE_VERSION ? await startService(udid, _testmanagerd.TESTMANAGERD_SERVICE_NAME, opts.socket, true) : await startService(udid, _testmanagerd.TESTMANAGERD_SERVICE_NAME_VERSION_14, opts.socket));
}
async function startMCInstallService(udid, opts = {}) {
  const socket = await startService(udid, _mcinstall.MC_INSTALL_SERVICE_NAME, opts.socket);
  return new _mcinstall.MCInstallProxyService(new _plistService.default(socket));
}
async function startImageMounterService(udid, opts = {}) {
  const socket = await startService(udid, _imagemounter.MOBILE_IMAGE_MOUNTER_SERVICE_NAME, opts.socket, false);
  return new _imagemounter.ImageMounter(new _plistService.default(socket));
}
async function startService(udid, serviceName, socket, handshakeOnly = false) {
  const lockdown = await (0, _utilities.startLockdownSession)(udid, socket);
  try {
    const service = await lockdown.startService(serviceName);
    if (service.EnableServiceSSL) {
      return await (0, _utilities.connectPortSSL)(udid, service.Port, socket, handshakeOnly);
    } else {
      return await (0, _utilities.connectPort)(udid, service.Port, socket);
    }
  } finally {
    lockdown.close();
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJfdXRpbGl0aWVzIiwicmVxdWlyZSIsIl9zeXNsb2ciLCJfc2ltdWxhdGVsb2NhdGlvbiIsIl93ZWJpbnNwZWN0b3IiLCJfaW5zdGFsbGF0aW9uUHJveHkiLCJfYWZjIiwiX25vdGlmaWNhdGlvblByb3h5IiwiX2hvdXNlQXJyZXN0IiwiX2luc3RydW1lbnQiLCJfdGVzdG1hbmFnZXJkIiwiX21jaW5zdGFsbCIsIl9pbWFnZW1vdW50ZXIiLCJfcGxpc3RTZXJ2aWNlIiwiX2ludGVyb3BSZXF1aXJlRGVmYXVsdCIsIl9zZW12ZXIiLCJDUkFTSF9MT0dfU0VSVklDRV9OQU1FIiwiSU5TVFJVTUVOVF9IQU5EU0hBS0VfVkVSU0lPTiIsIlRFU1RNQU5BR0VSRF9IQU5EU0hBS0VfVkVSU0lPTiIsInN0YXJ0U3lzbG9nU2VydmljZSIsInVkaWQiLCJvcHRzIiwic29ja2V0Iiwic3RhcnRTZXJ2aWNlIiwiU1lTTE9HX1NFUlZJQ0VfTkFNRSIsIlN5c2xvZ1NlcnZpY2UiLCJzdGFydFNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlIiwiU0lNVUxBVEVfTE9DQVRJT05fU0VSVklDRV9OQU1FIiwiU2ltdWxhdGVMb2NhdGlvblNlcnZpY2UiLCJzdGFydFdlYkluc3BlY3RvclNlcnZpY2UiLCJvc1ZlcnNpb24iLCJnZXRPU1ZlcnNpb24iLCJpc1NpbXVsYXRvciIsInZlcmJvc2UiLCJ2ZXJib3NlSGV4RHVtcCIsInNvY2tldENodW5rU2l6ZSIsIm1heEZyYW1lTGVuZ3RoIiwic2VtdmVyVmVyc2lvbiIsInNlbXZlciIsImNvZXJjZSIsIkVycm9yIiwiV2ViSW5zcGVjdG9yU2VydmljZSIsIm1ham9yT3NWZXJzaW9uIiwibWFqb3IiLCJzb2NrZXRDbGllbnQiLCJXRUJfSU5TUEVDVE9SX1NFUlZJQ0VfTkFNRSIsInVuZGVmaW5lZCIsInN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlIiwiSU5TVEFMTEFUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSIsIkluc3RhbGxhdGlvblByb3h5U2VydmljZSIsIlBsaXN0U2VydmljZSIsInN0YXJ0QWZjU2VydmljZSIsIkFGQ19TRVJWSUNFX05BTUUiLCJBZmNTZXJ2aWNlIiwic3RhcnRDcmFzaExvZ1NlcnZpY2UiLCJzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSIsIk5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUiLCJOb3RpZmljYXRpb25Qcm94eVNlcnZpY2UiLCJzdGFydEhvdXNlQXJyZXN0U2VydmljZSIsIkhPVVNFX0FSUkVTVF9TRVJWSUNFX05BTUUiLCJIb3VzZUFycmVzdFNlcnZpY2UiLCJzdGFydEluc3RydW1lbnRTZXJ2aWNlIiwiSW5zdHJ1bWVudFNlcnZpY2UiLCJwYXJzZUludCIsInNwbGl0IiwiSU5TVFJVTUVOVF9TRVJWSUNFX05BTUUiLCJJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRV9WRVJTSU9OXzE0Iiwic3RhcnRUZXN0bWFuYWdlcmRTZXJ2aWNlIiwiVGVzdG1hbmFnZXJkU2VydmljZSIsIlRFU1RNQU5BR0VSRF9TRVJWSUNFX05BTUUiLCJURVNUTUFOQUdFUkRfU0VSVklDRV9OQU1FX1ZFUlNJT05fMTQiLCJzdGFydE1DSW5zdGFsbFNlcnZpY2UiLCJNQ19JTlNUQUxMX1NFUlZJQ0VfTkFNRSIsIk1DSW5zdGFsbFByb3h5U2VydmljZSIsInN0YXJ0SW1hZ2VNb3VudGVyU2VydmljZSIsIk1PQklMRV9JTUFHRV9NT1VOVEVSX1NFUlZJQ0VfTkFNRSIsIkltYWdlTW91bnRlciIsInNlcnZpY2VOYW1lIiwiaGFuZHNoYWtlT25seSIsImxvY2tkb3duIiwic3RhcnRMb2NrZG93blNlc3Npb24iLCJzZXJ2aWNlIiwiRW5hYmxlU2VydmljZVNTTCIsImNvbm5lY3RQb3J0U1NMIiwiUG9ydCIsImNvbm5lY3RQb3J0IiwiY2xvc2UiXSwic291cmNlcyI6WyIuLi8uLi9saWIvc2VydmljZXMuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgY29ubmVjdFBvcnQsIGNvbm5lY3RQb3J0U1NMLCBzdGFydExvY2tkb3duU2Vzc2lvbiwgZ2V0T1NWZXJzaW9uIH0gZnJvbSAnLi91dGlsaXRpZXMnO1xuaW1wb3J0IHsgU3lzbG9nU2VydmljZSwgU1lTTE9HX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vc3lzbG9nJztcbmltcG9ydCB7IFNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlLCBTSU1VTEFURV9MT0NBVElPTl9TRVJWSUNFX05BTUUgfSBmcm9tICcuL3NpbXVsYXRlbG9jYXRpb24nO1xuaW1wb3J0IHsgV2ViSW5zcGVjdG9yU2VydmljZSwgV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUgfSBmcm9tICcuL3dlYmluc3BlY3Rvcic7XG5pbXBvcnQgeyBJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UsIElOU1RBTExBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUgfSBmcm9tICcuL2luc3RhbGxhdGlvbi1wcm94eSc7XG5pbXBvcnQgeyBBZmNTZXJ2aWNlLCBBRkNfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9hZmMnO1xuaW1wb3J0IHsgTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlLCBOT1RJRklDQVRJT05fUFJPWFlfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9ub3RpZmljYXRpb24tcHJveHknO1xuaW1wb3J0IHsgSG91c2VBcnJlc3RTZXJ2aWNlLCBIT1VTRV9BUlJFU1RfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9ob3VzZS1hcnJlc3QnO1xuaW1wb3J0IHsgSW5zdHJ1bWVudFNlcnZpY2UsIElOU1RSVU1FTlRfU0VSVklDRV9OQU1FX1ZFUlNJT05fMTQsIElOU1RSVU1FTlRfU0VSVklDRV9OQU1FIH0gZnJvbSAnLi9pbnN0cnVtZW50JztcbmltcG9ydCB7IFRlc3RtYW5hZ2VyZFNlcnZpY2UsIFRFU1RNQU5BR0VSRF9TRVJWSUNFX05BTUVfVkVSU0lPTl8xNCwgVEVTVE1BTkFHRVJEX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vdGVzdG1hbmFnZXJkJztcbmltcG9ydCB7IE1DSW5zdGFsbFByb3h5U2VydmljZSwgTUNfSU5TVEFMTF9TRVJWSUNFX05BTUUgfSBmcm9tICcuL21jaW5zdGFsbCc7XG5pbXBvcnQgeyBJbWFnZU1vdW50ZXIsIE1PQklMRV9JTUFHRV9NT1VOVEVSX1NFUlZJQ0VfTkFNRSB9IGZyb20gJy4vaW1hZ2Vtb3VudGVyJztcbmltcG9ydCBQbGlzdFNlcnZpY2UgZnJvbSAnLi9wbGlzdC1zZXJ2aWNlJztcbmltcG9ydCBzZW12ZXIgZnJvbSAnc2VtdmVyJztcblxuXG5jb25zdCBDUkFTSF9MT0dfU0VSVklDRV9OQU1FID0gJ2NvbS5hcHBsZS5jcmFzaHJlcG9ydGNvcHltb2JpbGUnO1xuY29uc3QgSU5TVFJVTUVOVF9IQU5EU0hBS0VfVkVSU0lPTiA9IDE0O1xuY29uc3QgVEVTVE1BTkFHRVJEX0hBTkRTSEFLRV9WRVJTSU9OID0gMTQ7XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U3lzbG9nU2VydmljZSh1ZGlkLCBvcHRzID0ge30pIHtcbiAgY29uc3Qgc29ja2V0ID0gYXdhaXQgc3RhcnRTZXJ2aWNlKHVkaWQsIFNZU0xPR19TRVJWSUNFX05BTUUsIG9wdHMuc29ja2V0KTtcbiAgcmV0dXJuIG5ldyBTeXNsb2dTZXJ2aWNlKHNvY2tldCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2ltdWxhdGVMb2NhdGlvblNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHNvY2tldCA9IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBTSU1VTEFURV9MT0NBVElPTl9TRVJWSUNFX05BTUUsIG9wdHMuc29ja2V0KTtcbiAgcmV0dXJuIG5ldyBTaW11bGF0ZUxvY2F0aW9uU2VydmljZShzb2NrZXQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydFdlYkluc3BlY3RvclNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IG9zVmVyc2lvbiA9IG9wdHMub3NWZXJzaW9uIHx8IGF3YWl0IGdldE9TVmVyc2lvbih1ZGlkLCBvcHRzLnNvY2tldCk7XG4gIGNvbnN0IGlzU2ltdWxhdG9yID0gISFvcHRzLmlzU2ltdWxhdG9yO1xuICBjb25zdCB2ZXJib3NlID0gISFvcHRzLnZlcmJvc2U7XG4gIGNvbnN0IHZlcmJvc2VIZXhEdW1wID0gISFvcHRzLnZlcmJvc2VIZXhEdW1wO1xuICBjb25zdCBzb2NrZXRDaHVua1NpemUgPSBvcHRzLnNvY2tldENodW5rU2l6ZTtcbiAgY29uc3QgbWF4RnJhbWVMZW5ndGggPSBvcHRzLm1heEZyYW1lTGVuZ3RoO1xuICBjb25zdCBzZW12ZXJWZXJzaW9uID0gc2VtdmVyLmNvZXJjZShvc1ZlcnNpb24pO1xuICBpZiAoIXNlbXZlclZlcnNpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBjcmVhdGUgYSBzZW12ZXIgdmVyc2lvbiBvdXQgb2YgJyR7b3NWZXJzaW9ufSdgKTtcbiAgfVxuICBpZiAob3B0cy5zb2NrZXQpIHtcbiAgICByZXR1cm4gbmV3IFdlYkluc3BlY3RvclNlcnZpY2Uoe1xuICAgICAgbWFqb3JPc1ZlcnNpb246IHNlbXZlclZlcnNpb24ubWFqb3IsXG4gICAgICBpc1NpbXVsYXRvcixcbiAgICAgIHNvY2tldENodW5rU2l6ZSxcbiAgICAgIHZlcmJvc2UsXG4gICAgICB2ZXJib3NlSGV4RHVtcCxcbiAgICAgIHNvY2tldENsaWVudDogb3B0cy5zb2NrZXQsXG4gICAgICBtYXhGcmFtZUxlbmd0aCxcbiAgICB9KTtcbiAgfVxuICBjb25zdCBzb2NrZXQgPSBhd2FpdCBzdGFydFNlcnZpY2UodWRpZCwgV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUsIHVuZGVmaW5lZCk7XG4gIHJldHVybiBuZXcgV2ViSW5zcGVjdG9yU2VydmljZSh7XG4gICAgbWFqb3JPc1ZlcnNpb246IHNlbXZlclZlcnNpb24ubWFqb3IsXG4gICAgaXNTaW11bGF0b3IsXG4gICAgc29ja2V0Q2h1bmtTaXplLFxuICAgIHZlcmJvc2UsXG4gICAgdmVyYm9zZUhleER1bXAsXG4gICAgc29ja2V0Q2xpZW50OiBzb2NrZXQsXG4gICAgbWF4RnJhbWVMZW5ndGgsXG4gIH0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh1ZGlkLCBvcHRzID0ge30pIHtcbiAgY29uc3Qgc29ja2V0ID0gYXdhaXQgc3RhcnRTZXJ2aWNlKHVkaWQsIElOU1RBTExBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUsIG9wdHMuc29ja2V0KTtcbiAgcmV0dXJuIG5ldyBJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UobmV3IFBsaXN0U2VydmljZShzb2NrZXQpKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRBZmNTZXJ2aWNlKHVkaWQsIG9wdHMgPSB7fSkge1xuICBjb25zdCBzb2NrZXQgPSBhd2FpdCBzdGFydFNlcnZpY2UodWRpZCwgQUZDX1NFUlZJQ0VfTkFNRSwgb3B0cy5zb2NrZXQpO1xuICByZXR1cm4gbmV3IEFmY1NlcnZpY2Uoc29ja2V0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRDcmFzaExvZ1NlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHNvY2tldCA9IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBDUkFTSF9MT0dfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCk7XG4gIHJldHVybiBuZXcgQWZjU2VydmljZShzb2NrZXQpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSh1ZGlkLCBvcHRzID0ge30pIHtcbiAgY29uc3Qgc29ja2V0ID0gYXdhaXQgc3RhcnRTZXJ2aWNlKHVkaWQsIE5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUsIG9wdHMuc29ja2V0KTtcbiAgcmV0dXJuIG5ldyBOb3RpZmljYXRpb25Qcm94eVNlcnZpY2Uoc29ja2V0KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHNvY2tldCA9IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBIT1VTRV9BUlJFU1RfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCk7XG4gIHJldHVybiBuZXcgSG91c2VBcnJlc3RTZXJ2aWNlKHNvY2tldCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IG9zVmVyc2lvbiA9IG9wdHMub3NWZXJzaW9uIHx8IGF3YWl0IGdldE9TVmVyc2lvbih1ZGlkLCBvcHRzLnNvY2tldCk7XG4gIHJldHVybiBuZXcgSW5zdHJ1bWVudFNlcnZpY2UocGFyc2VJbnQob3NWZXJzaW9uLnNwbGl0KCcuJylbMF0sIDEwKSA8IElOU1RSVU1FTlRfSEFORFNIQUtFX1ZFUlNJT05cbiAgICA/IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRSwgb3B0cy5zb2NrZXQsIHRydWUpXG4gICAgOiBhd2FpdCBzdGFydFNlcnZpY2UodWRpZCwgSU5TVFJVTUVOVF9TRVJWSUNFX05BTUVfVkVSU0lPTl8xNCwgb3B0cy5zb2NrZXQpXG4gICk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSh1ZGlkLCBvcHRzID0ge30pIHtcbiAgY29uc3Qgb3NWZXJzaW9uID0gb3B0cy5vc1ZlcnNpb24gfHwgYXdhaXQgZ2V0T1NWZXJzaW9uKHVkaWQsIG9wdHMuc29ja2V0KTtcbiAgcmV0dXJuIG5ldyBUZXN0bWFuYWdlcmRTZXJ2aWNlKHBhcnNlSW50KG9zVmVyc2lvbi5zcGxpdCgnLicpWzBdLCAxMCkgPCBURVNUTUFOQUdFUkRfSEFORFNIQUtFX1ZFUlNJT05cbiAgICA/IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBURVNUTUFOQUdFUkRfU0VSVklDRV9OQU1FLCBvcHRzLnNvY2tldCwgdHJ1ZSlcbiAgICA6IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBURVNUTUFOQUdFUkRfU0VSVklDRV9OQU1FX1ZFUlNJT05fMTQsIG9wdHMuc29ja2V0KVxuICApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydE1DSW5zdGFsbFNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHNvY2tldCA9IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBNQ19JTlNUQUxMX1NFUlZJQ0VfTkFNRSwgb3B0cy5zb2NrZXQpO1xuICByZXR1cm4gbmV3IE1DSW5zdGFsbFByb3h5U2VydmljZShuZXcgUGxpc3RTZXJ2aWNlKHNvY2tldCkpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBzdGFydEltYWdlTW91bnRlclNlcnZpY2UodWRpZCwgb3B0cyA9IHt9KSB7XG4gIGNvbnN0IHNvY2tldCA9IGF3YWl0IHN0YXJ0U2VydmljZSh1ZGlkLCBNT0JJTEVfSU1BR0VfTU9VTlRFUl9TRVJWSUNFX05BTUUsIG9wdHMuc29ja2V0LCBmYWxzZSk7XG4gIHJldHVybiBuZXcgSW1hZ2VNb3VudGVyKG5ldyBQbGlzdFNlcnZpY2Uoc29ja2V0KSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHN0YXJ0U2VydmljZSh1ZGlkLCBzZXJ2aWNlTmFtZSwgc29ja2V0LCBoYW5kc2hha2VPbmx5ID0gZmFsc2UpIHtcbiAgY29uc3QgbG9ja2Rvd24gPSBhd2FpdCBzdGFydExvY2tkb3duU2Vzc2lvbih1ZGlkLCBzb2NrZXQpO1xuICB0cnkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBsb2NrZG93bi5zdGFydFNlcnZpY2Uoc2VydmljZU5hbWUpO1xuICAgIGlmIChzZXJ2aWNlLkVuYWJsZVNlcnZpY2VTU0wpIHtcbiAgICAgIHJldHVybiBhd2FpdCBjb25uZWN0UG9ydFNTTCh1ZGlkLCBzZXJ2aWNlLlBvcnQsIHNvY2tldCwgaGFuZHNoYWtlT25seSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBhd2FpdCBjb25uZWN0UG9ydCh1ZGlkLCBzZXJ2aWNlLlBvcnQsIHNvY2tldCk7XG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIGxvY2tkb3duLmNsb3NlKCk7XG4gIH1cbn1cblxuZXhwb3J0IHtcbiAgc3RhcnRTeXNsb2dTZXJ2aWNlLCBzdGFydFdlYkluc3BlY3RvclNlcnZpY2UsXG4gIHN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlLCBzdGFydFNpbXVsYXRlTG9jYXRpb25TZXJ2aWNlLFxuICBzdGFydEFmY1NlcnZpY2UsIHN0YXJ0Q3Jhc2hMb2dTZXJ2aWNlLCBzdGFydE5vdGlmaWNhdGlvblByb3h5U2VydmljZSxcbiAgc3RhcnRIb3VzZUFycmVzdFNlcnZpY2UsIHN0YXJ0SW5zdHJ1bWVudFNlcnZpY2UsIHN0YXJ0VGVzdG1hbmFnZXJkU2VydmljZSxcbiAgc3RhcnRNQ0luc3RhbGxTZXJ2aWNlLCBzdGFydEltYWdlTW91bnRlclNlcnZpY2Vcbn07Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUEsSUFBQUEsVUFBQSxHQUFBQyxPQUFBO0FBQ0EsSUFBQUMsT0FBQSxHQUFBRCxPQUFBO0FBQ0EsSUFBQUUsaUJBQUEsR0FBQUYsT0FBQTtBQUNBLElBQUFHLGFBQUEsR0FBQUgsT0FBQTtBQUNBLElBQUFJLGtCQUFBLEdBQUFKLE9BQUE7QUFDQSxJQUFBSyxJQUFBLEdBQUFMLE9BQUE7QUFDQSxJQUFBTSxrQkFBQSxHQUFBTixPQUFBO0FBQ0EsSUFBQU8sWUFBQSxHQUFBUCxPQUFBO0FBQ0EsSUFBQVEsV0FBQSxHQUFBUixPQUFBO0FBQ0EsSUFBQVMsYUFBQSxHQUFBVCxPQUFBO0FBQ0EsSUFBQVUsVUFBQSxHQUFBVixPQUFBO0FBQ0EsSUFBQVcsYUFBQSxHQUFBWCxPQUFBO0FBQ0EsSUFBQVksYUFBQSxHQUFBQyxzQkFBQSxDQUFBYixPQUFBO0FBQ0EsSUFBQWMsT0FBQSxHQUFBRCxzQkFBQSxDQUFBYixPQUFBO0FBR0EsTUFBTWUsc0JBQXNCLEdBQUcsaUNBQWlDO0FBQ2hFLE1BQU1DLDRCQUE0QixHQUFHLEVBQUU7QUFDdkMsTUFBTUMsOEJBQThCLEdBQUcsRUFBRTtBQUV6QyxlQUFlQyxrQkFBa0JBLENBQUNDLElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ2pELE1BQU1DLE1BQU0sR0FBRyxNQUFNQyxZQUFZLENBQUNILElBQUksRUFBRUksMkJBQW1CLEVBQUVILElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQ3pFLE9BQU8sSUFBSUcscUJBQWEsQ0FBQ0gsTUFBTSxDQUFDO0FBQ2xDO0FBRUEsZUFBZUksNEJBQTRCQSxDQUFDTixJQUFJLEVBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUMzRCxNQUFNQyxNQUFNLEdBQUcsTUFBTUMsWUFBWSxDQUFDSCxJQUFJLEVBQUVPLGdEQUE4QixFQUFFTixJQUFJLENBQUNDLE1BQU0sQ0FBQztFQUNwRixPQUFPLElBQUlNLHlDQUF1QixDQUFDTixNQUFNLENBQUM7QUFDNUM7QUFFQSxlQUFlTyx3QkFBd0JBLENBQUNULElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3ZELE1BQU1TLFNBQVMsR0FBR1QsSUFBSSxDQUFDUyxTQUFTLEtBQUksTUFBTSxJQUFBQyx1QkFBWSxFQUFDWCxJQUFJLEVBQUVDLElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQ3pFLE1BQU1VLFdBQVcsR0FBRyxDQUFDLENBQUNYLElBQUksQ0FBQ1csV0FBVztFQUN0QyxNQUFNQyxPQUFPLEdBQUcsQ0FBQyxDQUFDWixJQUFJLENBQUNZLE9BQU87RUFDOUIsTUFBTUMsY0FBYyxHQUFHLENBQUMsQ0FBQ2IsSUFBSSxDQUFDYSxjQUFjO0VBQzVDLE1BQU1DLGVBQWUsR0FBR2QsSUFBSSxDQUFDYyxlQUFlO0VBQzVDLE1BQU1DLGNBQWMsR0FBR2YsSUFBSSxDQUFDZSxjQUFjO0VBQzFDLE1BQU1DLGFBQWEsR0FBR0MsZUFBTSxDQUFDQyxNQUFNLENBQUNULFNBQVMsQ0FBQztFQUM5QyxJQUFJLENBQUNPLGFBQWEsRUFBRTtJQUNsQixNQUFNLElBQUlHLEtBQUssQ0FBRSw2Q0FBNENWLFNBQVUsR0FBRSxDQUFDO0VBQzVFO0VBQ0EsSUFBSVQsSUFBSSxDQUFDQyxNQUFNLEVBQUU7SUFDZixPQUFPLElBQUltQixpQ0FBbUIsQ0FBQztNQUM3QkMsY0FBYyxFQUFFTCxhQUFhLENBQUNNLEtBQUs7TUFDbkNYLFdBQVc7TUFDWEcsZUFBZTtNQUNmRixPQUFPO01BQ1BDLGNBQWM7TUFDZFUsWUFBWSxFQUFFdkIsSUFBSSxDQUFDQyxNQUFNO01BQ3pCYztJQUNGLENBQUMsQ0FBQztFQUNKO0VBQ0EsTUFBTWQsTUFBTSxHQUFHLE1BQU1DLFlBQVksQ0FBQ0gsSUFBSSxFQUFFeUIsd0NBQTBCLEVBQUVDLFNBQVMsQ0FBQztFQUM5RSxPQUFPLElBQUlMLGlDQUFtQixDQUFDO0lBQzdCQyxjQUFjLEVBQUVMLGFBQWEsQ0FBQ00sS0FBSztJQUNuQ1gsV0FBVztJQUNYRyxlQUFlO0lBQ2ZGLE9BQU87SUFDUEMsY0FBYztJQUNkVSxZQUFZLEVBQUV0QixNQUFNO0lBQ3BCYztFQUNGLENBQUMsQ0FBQztBQUNKO0FBRUEsZUFBZVcsNkJBQTZCQSxDQUFDM0IsSUFBSSxFQUFFQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDNUQsTUFBTUMsTUFBTSxHQUFHLE1BQU1DLFlBQVksQ0FBQ0gsSUFBSSxFQUFFNEIsa0RBQStCLEVBQUUzQixJQUFJLENBQUNDLE1BQU0sQ0FBQztFQUNyRixPQUFPLElBQUkyQiwyQ0FBd0IsQ0FBQyxJQUFJQyxxQkFBWSxDQUFDNUIsTUFBTSxDQUFDLENBQUM7QUFDL0Q7QUFFQSxlQUFlNkIsZUFBZUEsQ0FBQy9CLElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQzlDLE1BQU1DLE1BQU0sR0FBRyxNQUFNQyxZQUFZLENBQUNILElBQUksRUFBRWdDLHFCQUFnQixFQUFFL0IsSUFBSSxDQUFDQyxNQUFNLENBQUM7RUFDdEUsT0FBTyxJQUFJK0IsZUFBVSxDQUFDL0IsTUFBTSxDQUFDO0FBQy9CO0FBRUEsZUFBZWdDLG9CQUFvQkEsQ0FBQ2xDLElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ25ELE1BQU1DLE1BQU0sR0FBRyxNQUFNQyxZQUFZLENBQUNILElBQUksRUFBRUosc0JBQXNCLEVBQUVLLElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQzVFLE9BQU8sSUFBSStCLGVBQVUsQ0FBQy9CLE1BQU0sQ0FBQztBQUMvQjtBQUVBLGVBQWVpQyw2QkFBNkJBLENBQUNuQyxJQUFJLEVBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUM1RCxNQUFNQyxNQUFNLEdBQUcsTUFBTUMsWUFBWSxDQUFDSCxJQUFJLEVBQUVvQyxrREFBK0IsRUFBRW5DLElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQ3JGLE9BQU8sSUFBSW1DLDJDQUF3QixDQUFDbkMsTUFBTSxDQUFDO0FBQzdDO0FBRUEsZUFBZW9DLHVCQUF1QkEsQ0FBQ3RDLElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3RELE1BQU1DLE1BQU0sR0FBRyxNQUFNQyxZQUFZLENBQUNILElBQUksRUFBRXVDLHNDQUF5QixFQUFFdEMsSUFBSSxDQUFDQyxNQUFNLENBQUM7RUFDL0UsT0FBTyxJQUFJc0MsK0JBQWtCLENBQUN0QyxNQUFNLENBQUM7QUFDdkM7QUFFQSxlQUFldUMsc0JBQXNCQSxDQUFDekMsSUFBSSxFQUFFQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDckQsTUFBTVMsU0FBUyxHQUFHVCxJQUFJLENBQUNTLFNBQVMsS0FBSSxNQUFNLElBQUFDLHVCQUFZLEVBQUNYLElBQUksRUFBRUMsSUFBSSxDQUFDQyxNQUFNLENBQUM7RUFDekUsT0FBTyxJQUFJd0MsNkJBQWlCLENBQUNDLFFBQVEsQ0FBQ2pDLFNBQVMsQ0FBQ2tDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsR0FBRy9DLDRCQUE0QixHQUM3RixNQUFNTSxZQUFZLENBQUNILElBQUksRUFBRTZDLG1DQUF1QixFQUFFNUMsSUFBSSxDQUFDQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEdBQ3BFLE1BQU1DLFlBQVksQ0FBQ0gsSUFBSSxFQUFFOEMsOENBQWtDLEVBQUU3QyxJQUFJLENBQUNDLE1BQU0sQ0FDNUUsQ0FBQztBQUNIO0FBRUEsZUFBZTZDLHdCQUF3QkEsQ0FBQy9DLElBQUksRUFBRUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxFQUFFO0VBQ3ZELE1BQU1TLFNBQVMsR0FBR1QsSUFBSSxDQUFDUyxTQUFTLEtBQUksTUFBTSxJQUFBQyx1QkFBWSxFQUFDWCxJQUFJLEVBQUVDLElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQ3pFLE9BQU8sSUFBSThDLGlDQUFtQixDQUFDTCxRQUFRLENBQUNqQyxTQUFTLENBQUNrQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUc5Qyw4QkFBOEIsR0FDakcsTUFBTUssWUFBWSxDQUFDSCxJQUFJLEVBQUVpRCx1Q0FBeUIsRUFBRWhELElBQUksQ0FBQ0MsTUFBTSxFQUFFLElBQUksQ0FBQyxHQUN0RSxNQUFNQyxZQUFZLENBQUNILElBQUksRUFBRWtELGtEQUFvQyxFQUFFakQsSUFBSSxDQUFDQyxNQUFNLENBQzlFLENBQUM7QUFDSDtBQUVBLGVBQWVpRCxxQkFBcUJBLENBQUNuRCxJQUFJLEVBQUVDLElBQUksR0FBRyxDQUFDLENBQUMsRUFBRTtFQUNwRCxNQUFNQyxNQUFNLEdBQUcsTUFBTUMsWUFBWSxDQUFDSCxJQUFJLEVBQUVvRCxrQ0FBdUIsRUFBRW5ELElBQUksQ0FBQ0MsTUFBTSxDQUFDO0VBQzdFLE9BQU8sSUFBSW1ELGdDQUFxQixDQUFDLElBQUl2QixxQkFBWSxDQUFDNUIsTUFBTSxDQUFDLENBQUM7QUFDNUQ7QUFFQSxlQUFlb0Qsd0JBQXdCQSxDQUFDdEQsSUFBSSxFQUFFQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLEVBQUU7RUFDdkQsTUFBTUMsTUFBTSxHQUFHLE1BQU1DLFlBQVksQ0FBQ0gsSUFBSSxFQUFFdUQsK0NBQWlDLEVBQUV0RCxJQUFJLENBQUNDLE1BQU0sRUFBRSxLQUFLLENBQUM7RUFDOUYsT0FBTyxJQUFJc0QsMEJBQVksQ0FBQyxJQUFJMUIscUJBQVksQ0FBQzVCLE1BQU0sQ0FBQyxDQUFDO0FBQ25EO0FBRUEsZUFBZUMsWUFBWUEsQ0FBQ0gsSUFBSSxFQUFFeUQsV0FBVyxFQUFFdkQsTUFBTSxFQUFFd0QsYUFBYSxHQUFHLEtBQUssRUFBRTtFQUM1RSxNQUFNQyxRQUFRLEdBQUcsTUFBTSxJQUFBQywrQkFBb0IsRUFBQzVELElBQUksRUFBRUUsTUFBTSxDQUFDO0VBQ3pELElBQUk7SUFDRixNQUFNMkQsT0FBTyxHQUFHLE1BQU1GLFFBQVEsQ0FBQ3hELFlBQVksQ0FBQ3NELFdBQVcsQ0FBQztJQUN4RCxJQUFJSSxPQUFPLENBQUNDLGdCQUFnQixFQUFFO01BQzVCLE9BQU8sTUFBTSxJQUFBQyx5QkFBYyxFQUFDL0QsSUFBSSxFQUFFNkQsT0FBTyxDQUFDRyxJQUFJLEVBQUU5RCxNQUFNLEVBQUV3RCxhQUFhLENBQUM7SUFDeEUsQ0FBQyxNQUFNO01BQ0wsT0FBTyxNQUFNLElBQUFPLHNCQUFXLEVBQUNqRSxJQUFJLEVBQUU2RCxPQUFPLENBQUNHLElBQUksRUFBRTlELE1BQU0sQ0FBQztJQUN0RDtFQUNGLENBQUMsU0FBUztJQUNSeUQsUUFBUSxDQUFDTyxLQUFLLENBQUMsQ0FBQztFQUNsQjtBQUNGIn0=